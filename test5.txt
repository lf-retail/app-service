using workflow ibps_deployment.yml

name: IBPS-deployment
run-name: IBPS-deployment-${{ github.event.inputs.release_version }}
on:
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version to deploy'
        required: true  

jobs:
  deploy:
    runs-on:
     group: rakbank-self-hosted-runner
     labels: dehitdevtra1

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Debug Working Directory
      run: |
        ls -al
        pwd
    - name: Make deploy.sh and rollback.sh executable
      run: |
        chmod +x deploy.sh rollback.sh
    - name: Run Ansible Playbook
      env:
        TOKEN_GITHUB: ${{ secrets.TOKEN_GITHUB }}
        RELEASE_VERSION: ${{ github.event.inputs.release_version }}
      run: |
        cd ${{ github.workspace }}
        #ansible-playbook -vvv -b --extra-vars "target=target_wasuat148 destination=${{ github.workspace }} deploy_mode=true rollback_mode=false release_version=${RELEASE_VERSION}" ./playbook/IBPS-deployment.yml
        ansible-playbook -vvv -b --extra-vars "target=target_wasuat209 destination=${{ github.workspace }} deploy_mode=true rollback_mode=false release_version=${RELEASE_VERSION}" ./playbook/IBPS-deployment.yml
        #ansible-playbook -vvv -b --extra-vars "target=target_wasuat210 destination=${{ github.workspace }} deploy_mode=true rollback_mode=false release_version=${RELEASE_VERSION}" ./playbook/IBPS-deployment.yml
        #ansible-playbook -vvv -b --extra-vars "target=target_wasreplica86 destination=${{ github.workspace }} deploy_mode=true rollback_mode=false release_version=${RELEASE_VERSION}" ./playbook/IBPS-deployment.yml

=======================
using playbook IBPS-deployment.yml
- hosts: '{{ target }}'
  become: yes
  become_user: itdevtra
  gather_facts: yes
  roles:
    - IBPS-deployment
==================

using roles/IBPS-deployment/defaults/main.yml

---
#ibps_server: 10.15.13.148:9043
github_token: "{{ lookup('env', 'TOKEN_GITHUB') }}"
release_version: "{{ lookup('env', 'RELEASE_VERSION') }}"
#zip_file_url: "https://maven.pkg.github.com/rakbank-internal/ibps-was-ansible-cd/Rak/IBPS/release/{{ lookup('env', 'RELEASE_VERSION') }}/release.{{ lookup('env', 'RELEASE_VERSION') }}.zip"
zip_file_url: "https://github.com/rakbank-internal/ibps-was-ansible-cd/releases/download/KYC-test_21032024/release.zip"
zip_file_name: "{{ zip_file_url | basename }}"
ansible_user: "itdevtra"
Profile_home: "/ibm/IBM/Application/release"
#Profile_home: "/ibm/IBM-CAS/WebSphere/deploy_script"
...
======================
using ansible.cfg
[defaults]
host_key_checking=False
deprecation_warnings=False
ansible_ssh_common_args='-o StrictHostKeyChecking=no'
ansible_ssh_extra_args='-o StrictHostKeyChecking=no'
remote_tmp=/tmp
inventory=hosts.cfg
roles_path=roles/
comment_warnings=False
command_warnings=False
interpreter_python=auto
ANSIBLE_DEPRECATION_WARNINGS=False
ANSIBLE_COMMAND_WARNINGS=False
allow_world_readable_tmpfiles=yes
timeout=30
ansible_pipelining=True
=======================
using host.cfg
[all:vars]
ansible_user=itdevtra
ansible_ssh_port=22

#[target_wasuat148]
#ANT3CASAPPS01 ansible_ssh_host=10.15.13.148

[target_wasuat209]
ANTIBPSAPP1 ansible_ssh_host=10.15.11.209

#[target_wasuat210]
#ANTIBPSAPP1 ansible_ssh_host=10.15.11.210

#[target_wasreplica86]
#ANT3CASAPPS02 ansible_ssh_host=10.15.24.86
============================
using roles/IBPS-deployment/tasks/main.yml

- name: Include deploy playbook
  include_tasks: main-deploy.yml
  when: deploy_mode

- name: Include rollback playbook
  include_tasks: main-rollback.yml
  when: rollback_mode
==================
using roles/IBPS-deployment/tasks/main-deploy.yml

- name: Download zip from GitHub packages on Runner
  delegate_to: localhost
  run_once: true
  get_url:
    url: "{{ zip_file_url }}"
    dest: "/tmp/{{ zip_file_name }}"
    headers:
      Authorization: "token {{ github_token }}"

- name: Create directory for new release version
  file:
    path: "{{ Profile_home }}/release.{{ release_version }}"
    state: directory
    mode: '0755'

- name: Copy zip to Target Server
  copy:
    src: "/tmp/{{ zip_file_name }}"
    dest: "{{ Profile_home }}/release.{{ release_version }}/{{ zip_file_name }}"
    mode: '0755'      
 
- name: Copy deploy.sh to Target Server
  copy:
    src: "/ansible/GITHUB_RUNNER/actions-runner10/_work/ibps-was-ansible-cd/ibps-was-ansible-cd/deploy.sh"
    dest: "{{ Profile_home }}/release.{{ release_version }}/deploy.sh"
    mode: '0755'
  become: yes
  become_user: "{{ ansible_user }}"

- name: Run deploy on Target Server
  become: yes
  become_user: "{{ ansible_user }}"
  shell: "cd {{ Profile_home }}/release.{{ release_version }} && ./deploy.sh {{ Profile_home }} {{ release_version }} {{ zip_file_url }} {{ zip_file_name }}"
  register: deploy_result
  ignore_errors: yes
==============
using deploy.sh
Profile_home="$1"
release_version="$2"
zip_file_url="$3"
zip_file_name="$4"

# Extract the zip file to a new release directory
unzip -q "$Profile_home/release.$release_version/$zip_file_name" -d "$Profile_home/release.$release_version"

# Check if release.txt exists
release_txt_path="$Profile_home/release.$release_version/release/release.txt"
if [ ! -f "$release_txt_path" ]; then
    echo "Error: release.txt not found at $release_txt_path"
    exit 1
fi

# Read the content of release.txt and remove any leading/trailing whitespace characters
release_content=$(sed 's/^[[:space:]]*//;s/[[:space:]]*$//' "$release_txt_path" 2>/dev/null)

# Print the content of release_content
echo "$release_content"

# Backup old deployment files for each application with timestamp
if [ -n "$release_content" ]; then
    backup_location="$Profile_home/release.$release_version"
    backup_timestamp=$(date +'%Y%m%d%H%M%S')
    backup_directory="$backup_location/backup-$backup_timestamp"
    mkdir -p "$backup_directory"
    chmod 777 "$backup_directory"

    # Copy release.txt file into backup directory
    cp "$release_txt_path" "$backup_directory"

    # Iterate through each line in release_content
    while IFS=, read -r app_name app_targeted_location; do
        # Check if both app_name and app_targeted_location are not empty
        if [ -n "$app_name" ] && [ -n "$app_targeted_location" ]; then
            # Construct paths for old deployment files and backup location
            old_deployment_path="$app_targeted_location"
            backup_path="$backup_directory/$app_name"

            # Copy old deployment files to backup location
            cp -r "$old_deployment_path" "$backup_path"

            # Print information about the backup
            echo "Backup: $app_name - $old_deployment_path -> $backup_path"

            # Define paths for new deployment files and targeted location
            new_deployment_path="$Profile_home/release.$release_version/release/$app_name"  # Assuming the new files are in the release directory

            # Copy new deployment files to targeted location
            cp -r "$new_deployment_path" "$app_targeted_location"

            # Print information about the copy
            echo "Copy: $app_name - $new_deployment_path -> $app_targeted_location"
        fi
    done <<< "$release_content"
fi
===================================

getting error

TASK [IBPS-deployment : Include deploy playbook] *******************************
task path: /ansible/GITHUB_RUNNER/actions-runner10/_work/ibps-was-ansible-cd/ibps-was-ansible-cd/roles/IBPS-deployment/tasks/main.yml:1
included: /ansible/GITHUB_RUNNER/actions-runner10/_work/ibps-was-ansible-cd/ibps-was-ansible-cd/roles/IBPS-deployment/tasks/main-deploy.yml for ANTIBPSAPP1

TASK [IBPS-deployment : Download zip from GitHub packages on Runner] ***********
task path: /ansible/GITHUB_RUNNER/actions-runner10/_work/ibps-was-ansible-cd/ibps-was-ansible-cd/roles/IBPS-deployment/tasks/main-deploy.yml:1
<localhost> ESTABLISH LOCAL CONNECTION FOR USER: itdevtra
<localhost> EXEC /bin/sh -c '( umask 77 && mkdir -p "` echo /tmp `"&& mkdir /tmp/ansible-tmp-1711024464.324629-2976997-270915104981055 && echo ansible-tmp-1711024464.324629-2976997-270915104981055="` echo /tmp/ansible-tmp-1711024464.324629-2976997-270915104981055 `" ) && sleep 0'
Using module file /usr/lib/python3.6/site-packages/ansible/modules/net_tools/basics/get_url.py
<localhost> PUT /home/itdevtra/.ansible/tmp/ansible-local-29769728eyrx9rc/tmpzdvty0ya TO /tmp/ansible-tmp-1711024464.324629-2976997-270915104981055/AnsiballZ_get_url.py
<localhost> EXEC /bin/sh -c 'chmod u+x /tmp/ansible-tmp-1711024464.324629-2976997-270915104981055/ /tmp/ansible-tmp-1711024464.324629-2976997-270915104981055/AnsiballZ_get_url.py && sleep 0'
<localhost> EXEC /bin/sh -c '/usr/libexec/platform-python /tmp/ansible-tmp-1711024464.324629-2976997-270915104981055/AnsiballZ_get_url.py && sleep 0'
<localhost> EXEC /bin/sh -c 'rm -f -r /tmp/ansible-tmp-1711024464.324629-2976997-270915104981055/ > /dev/null 2>&1 && sleep 0'
fatal: [ANTIBPSAPP1 -> localhost]: FAILED! => {
    "changed": false,
    "dest": "/tmp/release.zip",
    "elapsed": 1,
    "invocation": {
        "module_args": {
            "attributes": null,
            "backup": null,
            "checksum": "",
            "client_cert": null,
            "client_key": null,
            "content": null,
            "delimiter": null,
            "dest": "/tmp/release.zip",
            "directory_mode": null,
            "follow": false,
            "force": false,
            "force_basic_auth": false,
            "group": null,
            "headers": {
                "Authorization": "token ***"
            },
            "http_agent": "ansible-httpget",
            "mode": null,
            "owner": null,
            "regexp": null,
            "remote_src": null,
            "selevel": null,
            "serole": null,
            "setype": null,
            "seuser": null,
            "sha256sum": "",
            "src": null,
            "timeout": 10,
            "tmp_dest": null,
            "unsafe_writes": null,
            "url": "https://github.com/rakbank-internal/ibps-was-ansible-cd/releases/download/KYC-test_21032024/release.zip",
            "url_password": null,
            "url_username": null,
            "use_proxy": true,
            "validate_certs": true
        }
    },
    "msg": "Request failed",
    "response": "HTTP Error 404: Not Found",
    "status_code": 404,
    "url": "https://github.com/rakbank-internal/ibps-was-ansible-cd/releases/download/KYC-test_21032024/release.zip"
}

NO MORE HOSTS LEFT *************************************************************
===============

---
- name: Complete Workflow Including URL Accessibility Test
  hosts: localhost
  gather_facts: no
  vars:
    github_token: "{{ lookup('env', 'GITHUB_TOKEN') }}"  # Ensure this environment variable is set
    download_url: "https://github.com/rakbank-internal/ibps-was-ansible-cd/releases/download/KYC-test_21032024/release.zip"

  tasks:
    - name: Test URL Accessibility via Curl
      ansible.builtin.shell: |
        curl -s -o /dev/null -w "%{http_code}" -H "Authorization: token {{ github_token }}" "{{ download_url }}"
      register: curl_result
      ignore_errors: yes

    - name: Check if the URL is accessible
      fail:
        msg: "The URL is not accessible. HTTP Status Code: {{ curl_result.stdout }}"
      when: curl_result.stdout != "200"

    - name: Download the file using the URL (if accessible)
      ansible.builtin.get_url:
        url: "{{ download_url }}"
        dest: "/path/to/your/destination/release.zip"
        headers: "Authorization:token {{ github_token }}"
      when: curl_result.stdout == "200"

    # Add additional tasks here based on your requirements

====================

name: IBPS-deployment

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version to deploy'
        required: true

jobs:
  deploy:
    runs-on:
      group: rakbank-self-hosted-runner
      labels: dehitdevtra1

    steps:
      - uses: actions/checkout@v3

      - name: Debug Working Directory
        run: |
          ls -al
          pwd

      - name: Set environment variable
        env:
          ZIP_FILE_URL: "https://github.com/rakbank-internal/ibps-was-ansible-cd/releases/download/KYC-test_21032024/release.zip"

      - name: Run Ansible Playbook
        env:
          TOKEN_GITHUB: ${{ secrets.TOKEN_GITHUB }}  # assuming a secret named TOKEN_GITHUB is defined
          RELEASE_VERSION: ${{ github.event.inputs.release_version }}
        run: |
          cd ${{ github.workspace }}
          ansible-playbook -vvv -b --extra-vars "target=target_wasuat209 destination=${{ github.workspace }} deploy_mode=true rollback_mode=false release_version=${RELEASE_VERSION}" ./playbook/IBPS-deployment.yml
===================

zip_file_url: "{{ lookup('env', 'ZIP_FILE_URL') }}"
===========

[Yesterday 3:45 PM] Pradip Kanasani
    - name: get mcf_core release

      uses: robinraju/release-downloader@v1.9

      with:

        repository: "rakbank-internal/mcf_core"

        tag: ${{ github.event.inputs.mcf-tag }}

        fileName: ${{ github.event.inputs.mcf-fileName }}

        token: ${{ secrets.TOKEN_GITHUB }} 
=========================

      - name: Download MCF Core Release
        uses: robinraju/release-downloader@v1.9
        with:
          zip_file_url: "https://github.com/rakbank-internal/ibps-was-ansible-cd/releases/download/KYC-test_21032024/release.zip"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
================

Warning: Unexpected input(s) 'zip_file_url', valid inputs are ['repository', 'latest', 'preRelease', 'tag', 'fileName', 'tarBall', 'zipBall', 'out-file-path', 'extract', 'token', 'github-api-url', 'releaseId']
Run robinraju/release-downloader@v1.9
  with:
    zip_file_url: https://github.com/rakbank-internal/ibps-was-ansible-cd/releases/download/KYC-test_21032024/release.zip
    repository: rakbank-internal/ibps-was-ansible-cd
    latest: false
    preRelease: false
    fileName: *
    tarBall: false
    zipBall: false
    out-file-path: .
    extract: false
    token: ***
    github-api-url: https://api.github.com
  env:
    GITHUB_TOKEN: ***
Error: Config error: Please input a valid tag or release ID, or specify `latest`
===================

- name: Download MCF Core Release
  uses: robinraju/release-downloader@v1.9
  with:
    repository: rakbank-internal/ibps-was-ansible-cd
    latest: true
    fileName: release.zip  # Adjust the file name if needed
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
====================

    - name: Download IBPS Release
      uses: robinraju/release-downloader@v1.9
      with:
       repository: rakbank-internal/ibps-was-ansible-cd
       tag: KYC-test_21032024
       fileName: release.zip  # Adjust the file name if needed
      env:
       GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
===============

Run robinraju/release-downloader@v1.9
  with:
    repository: rakbank-internal/ibps-was-ansible-cd
    tag: KYC-test_21032024
    fileName: release.zip
    latest: false
    preRelease: false
    tarBall: false
    zipBall: false
    out-file-path: .
    extract: false
    token: ***
    github-api-url: https://api.github.com
  env:
    GITHUB_TOKEN: ***
Fetching release KYC-test_21032024 from repo rakbank-internal/ibps-was-ansible-cd
Found release tag: KYC-test_21032024
Downloading file: release.zip to: /ansible/GITHUB_RUNNER/actions-runner10/_work/ibps-was-ansible-cd/ibps-was-ansible-cd
Done: /ansible/GITHUB_RUNNER/actions-runner10/_work/ibps-was-ansible-cd/ibps-was-ansible-cd/release.zip
==============

- name: Download IBPS Release
  uses: robinraju/release-downloader@v1.9
  id: download_release
  with:
    repository: rakbank-internal/ibps-was-ansible-cd
    tag: KYC-test_21032024
    fileName: release.zip  # Adjust the file name if needed
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

- name: Set downloaded file URL as an environment variable
  run: echo "ZIP_FILE_URL=${{ steps.download_release.outputs.file_url }}" >> $GITHUB_ENV

-----------------
zip_file_url: ${{ env.ZIP_FILE_URL }}
=========

TASK [IBPS-deployment : Include deploy playbook] *******************************
task path: /ansible/GITHUB_RUNNER/actions-runner10/_work/ibps-was-ansible-cd/ibps-was-ansible-cd/roles/IBPS-deployment/tasks/main.yml:1
included: /ansible/GITHUB_RUNNER/actions-runner10/_work/ibps-was-ansible-cd/ibps-was-ansible-cd/roles/IBPS-deployment/tasks/main-deploy.yml for ANTIBPSAPP1

TASK [IBPS-deployment : Download zip from GitHub packages on Runner] ***********
task path: /ansible/GITHUB_RUNNER/actions-runner10/_work/ibps-was-ansible-cd/ibps-was-ansible-cd/roles/IBPS-deployment/tasks/main-deploy.yml:1
<localhost> ESTABLISH LOCAL CONNECTION FOR USER: itdevtra
<localhost> EXEC /bin/sh -c '( umask 77 && mkdir -p "` echo /tmp `"&& mkdir /tmp/ansible-tmp-1711092837.0172343-3365922-82411218375997 && echo ansible-tmp-1711092837.0172343-3365922-82411218375997="` echo /tmp/ansible-tmp-1711092837.0172343-3365922-82411218375997 `" ) && sleep 0'
Using module file /usr/lib/python3.6/site-packages/ansible/modules/net_tools/basics/get_url.py
<localhost> PUT /home/itdevtra/.ansible/tmp/ansible-local-3365901rlbd974k/tmpzlk6tt4h TO /tmp/ansible-tmp-1711092837.0172343-3365922-82411218375997/AnsiballZ_get_url.py
<localhost> EXEC /bin/sh -c 'chmod u+x /tmp/ansible-tmp-1711092837.0172343-3365922-82411218375997/ /tmp/ansible-tmp-1711092837.0172343-3365922-82411218375997/AnsiballZ_get_url.py && sleep 0'
<localhost> EXEC /bin/sh -c '/usr/libexec/platform-python /tmp/ansible-tmp-1711092837.0172343-3365922-82411218375997/AnsiballZ_get_url.py && sleep 0'
<localhost> EXEC /bin/sh -c 'rm -f -r /tmp/ansible-tmp-1711092837.0172343-3365922-82411218375997/ > /dev/null 2>&1 && sleep 0'
The full traceback is:
  File "/tmp/ansible_get_url_payload_1v0qjry1/ansible_get_url_payload.zip/ansible/module_utils/urls.py", line 1360, in fetch_url
    unix_socket=unix_socket)
  File "/tmp/ansible_get_url_payload_1v0qjry1/ansible_get_url_payload.zip/ansible/module_utils/urls.py", line 1257, in open_url
    use_gssapi=use_gssapi, unix_socket=unix_socket)
  File "/tmp/ansible_get_url_payload_1v0qjry1/ansible_get_url_payload.zip/ansible/module_utils/urls.py", line 1137, in open
    request = RequestWithMethod(url, method, data)
  File "/tmp/ansible_get_url_payload_1v0qjry1/ansible_get_url_payload.zip/ansible/module_utils/urls.py", line 548, in __init__
    urllib_request.Request.__init__(self, url, data, headers, origin_req_host, unverifiable)
  File "/usr/lib64/python3.6/urllib/request.py", line 329, in __init__
    self.full_url = url
  File "/usr/lib64/python3.6/urllib/request.py", line 355, in full_url
    self._parse()
  File "/usr/lib64/python3.6/urllib/request.py", line 384, in _parse
    raise ValueError("unknown url type: %r" % self.full_url)
fatal: [ANTIBPSAPP1 -> localhost]: FAILED! => {
    "changed": false,
    "invocation": {
        "module_args": {
            "attributes": null,
            "backup": null,
            "checksum": "",
            "client_cert": null,
            "client_key": null,
            "content": null,
            "delimiter": null,
            "dest": "/tmp/",
            "directory_mode": null,
            "follow": false,
            "force": false,
            "force_basic_auth": false,
            "group": null,
            "headers": {
                "Authorization": "token ***"
            },
            "http_agent": "ansible-httpget",
            "mode": null,
            "owner": null,
            "regexp": null,
            "remote_src": null,
            "selevel": null,
            "serole": null,
            "setype": null,
            "seuser": null,
            "sha256sum": "",
            "src": null,
            "timeout": 10,
            "tmp_dest": null,
            "unsafe_writes": null,
            "url": "",
            "url_password": null,
            "url_username": null,
            "use_proxy": true,
            "validate_certs": true
        }
    },
    "msg": "unknown url type: ''",
    "status": -1,
    "url": ""
}

NO MORE HOSTS LEFT *************************************************************

PLAY RECAP *********************************************************************
=======

Run echo "ZIP_FILE_URL=" >> $GITHUB_ENV 
  echo "ZIP_FILE_URL=" >> $GITHUB_ENV 
  ls -la "ZIP_FILE_URL"
  shell: /usr/bin/bash -e {0}
ls: cannot access 'ZIP_FILE_URL': No such file or directory
Error: Process completed with exit code 2.
