- name: Download zip from GitHub packages on Runner
  delegate_to: localhost
  run_once: true
  get_url:
    url: "{{ zip_file_url }}"
    dest: "/tmp/{{ zip_file_name }}"
    headers:
      Authorization: "token {{ github_token }}"
 
- name: Copy zip to Target Server
  copy:
    src: "/tmp/{{ zip_file_name }}"
    dest: "{{ Profile_home }}/{{ zip_file_name }}"
    mode: '0755'

- name: give permisson to targeted location
  ansible.builtin.file:
    path: "{{ targeted_location }}"
    mode: '0755'

- name: Copy deploy.sh to Target Server
  copy:
    src: "/ansible/GITHUB_RUNNER/actions-runner10/_work/ibps-was-ansible-cd/ibps-was-ansible-cd/deploy.sh"
    dest: "{{ Profile_home }}/deploy.sh"
    mode: '0755'
  become: yes
  become_user: "{{ ansible_user }}"

- name: Run deploy on Target Server
  become: yes
  become_user: "{{ ansible_user }}"
  shell: "cd {{ Profile_home }} && ./deploy.sh {{ Profile_home }} {{ zip_file_url }} {{ zip_file_name }} {{ backup_location }}"
  register: deploy_result
  ignore_errors: yes

- name: Run ls -la on the Target Server
  become: true
  become_user: itdevtra
  command: "ls -la "/ibm/IBM-CAS/WebSphere/AppServer/profiles/AppSrv01/installedApps"
  register: ls_result    

- name: Display ls -la result
  debug:
    var: ls_result.stdout_lines   

- name: Run ls -la on the Target Server
  become: true
  become_user: itdevtra
  command: "ls -la {{ backup_location }}"
  register: ls_result1    

- name: Display ls -la result
  debug:
    var: ls_result1.stdout_lines     

#- name: List files in targeted_location
 # become: true
  #become_user: itdevtra
  #command: "find {{ targeted_location }} -maxdepth 1 -type f"
  #register: files_list

#- debug:
 #   msg: "File found: {{ item }}"
  #loop: "{{ files_list.stdout_lines }}"
