#!/bin/bash

Profile_home="$1"
zip_file_url="$2"
zip_file_name="$3"
backup_location="$4"

echo "Profile_home: $Profile_home"
echo "zip_file_url: $zip_file_url"
echo "zip_file_name: $zip_file_name"

# Remove the existing release directory if it exists
rm -rf "$Profile_home/release"

# Use unzip to extract contents into the specified directory
unzip -q "$Profile_home/$zip_file_name" -d "$Profile_home/"

# Iterate over each file in the release directory
for file_path in "$Profile_home"/release/*; do
    if [ -f "$file_path" ]; then
        # Extract the file name
        file_name=$(basename "$file_path")
        # Define paths for new deployment files and targeted location
        new_deployment_path="$Profile_home/release/$file_name"
        targeted_path="$Profile_home/installedApps/ANT2CASAPPS01Node01Cell"

        # Check if the targeted location exists
        if [ -d "$targeted_path" ]; then
            # Copy new deployment files to targeted location, overwriting if necessary
            cp -rf "$new_deployment_path" "$targeted_path"

            # Print information about the copy
            echo "Copy: $file_name - $new_deployment_path -> $targeted_path"
        else
            echo "Skipping copy of $file_name. Targeted location $targeted_path does not exist."
        fi
    fi
done
===========================

#!/bin/bash

Profile_home="$1"
zip_file_url="$2"
zip_file_name="$3"
backup_location="$4"

echo "Profile_home: $Profile_home"
echo "zip_file_url: $zip_file_url"
echo "zip_file_name: $zip_file_name"

# Remove the existing release directory if it exists
rm -rf "$Profile_home/release"

# Use unzip to extract contents into the specified directory
unzip -q "$Profile_home/$zip_file_name" -d "$Profile_home/"

# Check if release.txt exists
if [ ! -f "$Profile_home/release/release.txt" ]; then
    echo "Error: release.txt file not found."
    exit 1
fi

# Change directory to the release directory
cd "$Profile_home/release" || exit

# Read the content of release.txt and process each line
while IFS=, read -r app_name app_targeted_location; do
    if [ -n "$app_targeted_location" ]; then
        # Define paths for application files and targeted location
        app_file="$Profile_home/release/$app_name"
        targeted_path="$app_targeted_location"

        # Check if the file exists in the release directory
        if [ -f "$app_file" ]; then
            # Create directories if they don't exist
            mkdir -p "$targeted_path"

            # Move application file to targeted location
            mv "$app_file" "$targeted_path/"

            # Print information about the move
            echo "Moved: $app_name to $targeted_path"
        else
            echo "Error: Application file $app_name not found in the release directory."
        fi
    fi
done < "release.txt"
=========================
TASK [IBPS-deployment : Run deploy on Target Server] ***************************
task path: /ansible/GITHUB_RUNNER/actions-runner10/_work/ibps-was-ansible-cd/ibps-was-ansible-cd/roles/IBPS-deployment/tasks/main.yml:24
<10.15.13.148> ESTABLISH SSH CONNECTION FOR USER: itdevtra
<10.15.13.148> SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o StrictHostKeyChecking=no -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o 'User="itdevtra"' -o ConnectTimeout=30 -o ControlPath=/home/itdevtra/.ansible/cp/2b6c10444a 10.15.13.148 '/bin/sh -c '"'"'( umask 77 && mkdir -p "` echo /tmp `"&& mkdir /tmp/ansible-tmp-1707410045.2146666-3264861-137146266347670 && echo ansible-tmp-1707410045.2146666-3264861-137146266347670="` echo /tmp/ansible-tmp-1707410045.2146666-3264861-137146266347670 `" ) && sleep 0'"'"''
<10.15.13.148> (0, b'ansible-tmp-1707410045.2146666-3264861-137146266347670=/tmp/ansible-tmp-1707410045.2146666-3264861-137146266347670\n', b'')
Using module file /usr/lib/python3.6/site-packages/ansible/modules/commands/command.py
<10.15.13.148> PUT /home/itdevtra/.ansible/tmp/ansible-local-3264733cbgbn6f5/tmpm26rvbl6 TO /tmp/ansible-tmp-1707410045.2146666-3264861-137146266347670/AnsiballZ_command.py
<10.15.13.148> SSH: EXEC sftp -b - -C -o ControlMaster=auto -o ControlPersist=60s -o StrictHostKeyChecking=no -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o 'User="itdevtra"' -o ConnectTimeout=30 -o ControlPath=/home/itdevtra/.ansible/cp/2b6c10444a '[10.15.13.148]'
<10.15.13.148> (0, b'sftp> put /home/itdevtra/.ansible/tmp/ansible-local-3264733cbgbn6f5/tmpm26rvbl6 /tmp/ansible-tmp-1707410045.2146666-3264861-137146266347670/AnsiballZ_command.py\n', b'')
<10.15.13.148> ESTABLISH SSH CONNECTION FOR USER: itdevtra
<10.15.13.148> SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o StrictHostKeyChecking=no -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o 'User="itdevtra"' -o ConnectTimeout=30 -o ControlPath=/home/itdevtra/.ansible/cp/2b6c10444a 10.15.13.148 '/bin/sh -c '"'"'chmod u+x /tmp/ansible-tmp-1707410045.2146666-3264861-137146266347670/ /tmp/ansible-tmp-1707410045.2146666-3264861-137146266347670/AnsiballZ_command.py && sleep 0'"'"''
<10.15.13.148> (0, b'', b'')
<10.15.13.148> ESTABLISH SSH CONNECTION FOR USER: itdevtra
<10.15.13.148> SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o StrictHostKeyChecking=no -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o 'User="itdevtra"' -o ConnectTimeout=30 -o ControlPath=/home/itdevtra/.ansible/cp/2b6c10444a -tt 10.15.13.148 '/bin/sh -c '"'"'/usr/bin/python /tmp/ansible-tmp-1707410045.2146666-3264861-137146266347670/AnsiballZ_command.py && sleep 0'"'"''
<10.15.13.148> (0, b'\r\n{"changed": true, "end": "2024-02-08 20:35:22.850378", "stdout": "Profile_home: /ibm/IBM-CAS/WebSphere/AppServer/profiles/AppSrv01/bin\\nzip_file_url: https://maven.pkg.github.com/rakbank-internal/ibps-was-ansible-cd/Rak/IBPS/release/1.0.0.2/release-1.0.0.2.zip\\nzip_file_name: release-1.0.0.2.zip\\ntotal 36\\ndrwxrwxr-x 6 itdevtra itdevtra  4096 Feb  8 20:35 .\\ndrwxrwxrwx 7 root     root     12288 Feb  8 20:35 ..\\ndrwxrwxr-x 3 itdevtra itdevtra  4096 Jan 31 14:15 newgenapp_jar.ear\\ndrwxrwxr-x 3 itdevtra itdevtra  4096 Jan 31 14:15 ofme_ejb.ear\\ndrwxrwxr-x 3 itdevtra itdevtra  4096 Jan 31 14:15 omniapp_ejb.ear\\n-rw-rw-r-- 1 itdevtra itdevtra   413 Jan 31 14:30 release.txt\\n-rw-rw-r-- 1 itdevtra itdevtra     0 Jan 31 14:30 rollback.txt\\ndrwxrwxr-x 3 itdevtra itdevtra  4096 Jan 31 14:15 WFS.ear\\nError: Application file newgenapp_jar.ear not found in the release directory.\\nError: Application file ofme_ejb.ear not found in the release directory.\\nError: Application file omniapp_ejb.ear not found in the release directory.", "cmd": "cd /ibm/IBM-CAS/WebSphere/AppServer/profiles/AppSrv01/bin && ./deploy.sh /ibm/IBM-CAS/WebSphere/AppServer/profiles/AppSrv01/bin https://maven.pkg.github.com/rakbank-internal/ibps-was-ansible-cd/Rak/IBPS/release/1.0.0.2/release-1.0.0.2.zip release-1.0.0.2.zip /ibm/IBM-CAS/WebSphere/backup", "rc": 0, "start": "2024-02-08 20:35:22.493675", "stderr": "", "delta": "0:00:00.356703", "invocation": {"module_args": {"creates": null, "executable": null, "_uses_shell": true, "strip_empty_ends": true, "_raw_params": "cd /ibm/IBM-CAS/WebSphere/AppServer/profiles/AppSrv01/bin && ./deploy.sh /ibm/IBM-CAS/WebSphere/AppServer/profiles/AppSrv01/bin https://maven.pkg.github.com/rakbank-internal/ibps-was-ansible-cd/Rak/IBPS/release/1.0.0.2/release-1.0.0.2.zip release-1.0.0.2.zip /ibm/IBM-CAS/WebSphere/backup", "removes": null, "argv": null, "warn": false, "chdir": null, "stdin_add_newline": true, "stdin": null}}}\r\n', b'Shared connection to 10.15.13.148 closed.\r\n')
<10.15.13.148> ESTABLISH SSH CONNECTION FOR USER: itdevtra
<10.15.13.148> SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o StrictHostKeyChecking=no -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o 'User="itdevtra"' -o ConnectTimeout=30 -o ControlPath=/home/itdevtra/.ansible/cp/2b6c10444a 10.15.13.148 '/bin/sh -c '"'"'rm -f -r /tmp/ansible-tmp-1707410045.2146666-3264861-137146266347670/ > /dev/null 2>&1 && sleep 0'"'"''
<10.15.13.148> (0, b'', b'')
changed: [ANT3CASAPPS01] => {
    "changed": true,
    "cmd": "cd /ibm/IBM-CAS/WebSphere/AppServer/profiles/AppSrv01/bin && ./deploy.sh /ibm/IBM-CAS/WebSphere/AppServer/profiles/AppSrv01/bin https://maven.pkg.github.com/rakbank-internal/ibps-was-ansible-cd/Rak/IBPS/release/1.0.0.2/release-1.0.0.2.zip release-1.0.0.2.zip /ibm/IBM-CAS/WebSphere/backup",
    "delta": "0:00:00.356703",
    "end": "2024-02-08 20:35:22.850378",
    "invocation": {
        "module_args": {
            "_raw_params": "cd /ibm/IBM-CAS/WebSphere/AppServer/profiles/AppSrv01/bin && ./deploy.sh /ibm/IBM-CAS/WebSphere/AppServer/profiles/AppSrv01/bin https://maven.pkg.github.com/rakbank-internal/ibps-was-ansible-cd/Rak/IBPS/release/1.0.0.2/release-1.0.0.2.zip release-1.0.0.2.zip /ibm/IBM-CAS/WebSphere/backup",
            "_uses_shell": true,
            "argv": null,
            "chdir": null,
            "creates": null,
            "executable": null,
            "removes": null,
            "stdin": null,
            "stdin_add_newline": true,
            "strip_empty_ends": true,
            "warn": false
        }
    },
    "rc": 0,
    "start": "2024-02-08 20:35:22.493675",
    "stderr": "",
    "stderr_lines": [],
    "stdout": "Profile_home: /ibm/IBM-CAS/WebSphere/AppServer/profiles/AppSrv01/bin\nzip_file_url: https://maven.pkg.github.com/rakbank-internal/ibps-was-ansible-cd/Rak/IBPS/release/1.0.0.2/release-1.0.0.2.zip\nzip_file_name: release-1.0.0.2.zip\ntotal 36\ndrwxrwxr-x 6 itdevtra itdevtra  4096 Feb  8 20:35 .\ndrwxrwxrwx 7 root     root     12288 Feb  8 20:35 ..\ndrwxrwxr-x 3 itdevtra itdevtra  4096 Jan 31 14:15 newgenapp_jar.ear\ndrwxrwxr-x 3 itdevtra itdevtra  4096 Jan 31 14:15 ofme_ejb.ear\ndrwxrwxr-x 3 itdevtra itdevtra  4096 Jan 31 14:15 omniapp_ejb.ear\n-rw-rw-r-- 1 itdevtra itdevtra   413 Jan 31 14:30 release.txt\n-rw-rw-r-- 1 itdevtra itdevtra     0 Jan 31 14:30 rollback.txt\ndrwxrwxr-x 3 itdevtra itdevtra  4096 Jan 31 14:15 WFS.ear\nError: Application file newgenapp_jar.ear not found in the release directory.\nError: Application file ofme_ejb.ear not found in the release directory.\nError: Application file omniapp_ejb.ear not found in the release directory.",
    "stdout_lines": [
        "Profile_home: /ibm/IBM-CAS/WebSphere/AppServer/profiles/AppSrv01/bin",
        "zip_file_url: https://maven.pkg.github.com/rakbank-internal/ibps-was-ansible-cd/Rak/IBPS/release/1.0.0.2/release-1.0.0.2.zip",
        "zip_file_name: release-1.0.0.2.zip",
        "total 36",
        "drwxrwxr-x 6 itdevtra itdevtra  4096 Feb  8 20:35 .",
        "drwxrwxrwx 7 root     root     12288 Feb  8 20:35 ..",
        "drwxrwxr-x 3 itdevtra itdevtra  4096 Jan 31 14:15 newgenapp_jar.ear",
        "drwxrwxr-x 3 itdevtra itdevtra  4096 Jan 31 14:15 ofme_ejb.ear",
        "drwxrwxr-x 3 itdevtra itdevtra  4096 Jan 31 14:15 omniapp_ejb.ear",
        "-rw-rw-r-- 1 itdevtra itdevtra   413 Jan 31 14:30 release.txt",
        "-rw-rw-r-- 1 itdevtra itdevtra     0 Jan 31 14:30 rollback.txt",
        "drwxrwxr-x 3 itdevtra itdevtra  4096 Jan 31 14:15 WFS.ear",
        "Error: Application file newgenapp_jar.ear not found in the release directory.",
        "Error: Application file ofme_ejb.ear not found in the release directory.",
        "Error: Application file omniapp_ejb.ear not found in the release directory."
    ]
}

TASK [IBPS-deployment : Run ls -la on the Target Server] ***********************
task path: /ansible/GITHUB_RUNNER/actions-runner10/_work/ibps-was-ansible-cd/ibps-was-ansible-cd/roles/IBPS-deployment/tasks/main.yml:31
<10.15.13.148> ESTABLISH SSH CONNECTION FOR USER: itdevtra
<10.15.13.148> SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o StrictHostKeyChecking=no -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o 'User="itdevtra"' -o ConnectTimeout=30 -o ControlPath=/home/itdevtra/.ansible/cp/2b6c10444a 10.15.13.148 '/bin/sh -c '"'"'( umask 77 && mkdir -p "` echo /tmp `"&& mkdir /tmp/ansible-tmp-1707410046.1299489-3264870-110034336375266 && echo ansible-tmp-1707410046.1299489-3264870-110034336375266="` echo /tmp/ansible-tmp-1707410046.1299489-3264870-110034336375266 `" ) && sleep 0'"'"''
<10.15.13.148> (0, b'ansible-tmp-1707410046.1299489-3264870-110034336375266=/tmp/ansible-tmp-1707410046.1299489-3264870-110034336375266\n', b'')
Using module file /usr/lib/python3.6/site-packages/ansible/modules/commands/command.py
<10.15.13.148> PUT /home/itdevtra/.ansible/tmp/ansible-local-3264733cbgbn6f5/tmpwrj1mci9 TO /tmp/ansible-tmp-1707410046.1299489-3264870-110034336375266/AnsiballZ_command.py
<10.15.13.148> SSH: EXEC sftp -b - -C -o ControlMaster=auto -o ControlPersist=60s -o StrictHostKeyChecking=no -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o 'User="itdevtra"' -o ConnectTimeout=30 -o ControlPath=/home/itdevtra/.ansible/cp/2b6c10444a '[10.15.13.148]'
<10.15.13.148> (0, b'sftp> put /home/itdevtra/.ansible/tmp/ansible-local-3264733cbgbn6f5/tmpwrj1mci9 /tmp/ansible-tmp-1707410046.1299489-3264870-110034336375266/AnsiballZ_command.py\n', b'')
<10.15.13.148> ESTABLISH SSH CONNECTION FOR USER: itdevtra
<10.15.13.148> SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o StrictHostKeyChecking=no -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o 'User="itdevtra"' -o ConnectTimeout=30 -o ControlPath=/home/itdevtra/.ansible/cp/2b6c10444a 10.15.13.148 '/bin/sh -c '"'"'chmod u+x /tmp/ansible-tmp-1707410046.1299489-3264870-110034336375266/ /tmp/ansible-tmp-1707410046.1299489-3264870-110034336375266/AnsiballZ_command.py && sleep 0'"'"''
<10.15.13.148> (0, b'', b'')
<10.15.13.148> ESTABLISH SSH CONNECTION FOR USER: itdevtra
<10.15.13.148> SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o StrictHostKeyChecking=no -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o 'User="itdevtra"' -o ConnectTimeout=30 -o ControlPath=/home/itdevtra/.ansible/cp/2b6c10444a -tt 10.15.13.148 '/bin/sh -c '"'"'/usr/bin/python /tmp/ansible-tmp-1707410046.1299489-3264870-110034336375266/AnsiballZ_command.py && sleep 0'"'"''
<10.15.13.148> (0, b'\r\n{"changed": true, "end": "2024-02-08 20:35:23.555811", "stdout": "total 12\\ndrwxrwxr-x 3 itdevtra itdevtra 4096 Feb  8 17:42 .\\ndrwxrwxrwx 7 root     root     4096 Feb  7 16:19 ..\\ndrwxrwxr-x 3 itdevtra itdevtra 4096 Feb  8 16:39 WFS.ear", "cmd": ["ls", "-la", "/ibm/IBM-CAS/WebSphere/AppServer/profiles/AppSrv01/installedApps/ANT2CASAPPS01Node01Cell"], "rc": 0, "start": "2024-02-08 20:35:23.225426", "stderr": "", "delta": "0:00:00.330385", "invocation": {"module_args": {"creates": null, "executable": null, "_uses_shell": false, "strip_empty_ends": true, "_raw_params": "ls -la /ibm/IBM-CAS/WebSphere/AppServer/profiles/AppSrv01/installedApps/ANT2CASAPPS01Node01Cell", "removes": null, "argv": null, "warn": false, "chdir": null, "stdin_add_newline": true, "stdin": null}}}\r\n', b'Shared connection to 10.15.13.148 closed.\r\n')
<10.15.13.148> ESTABLISH SSH CONNECTION FOR USER: itdevtra
<10.15.13.148> SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o StrictHostKeyChecking=no -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o 'User="itdevtra"' -o ConnectTimeout=30 -o ControlPath=/home/itdevtra/.ansible/cp/2b6c10444a 10.15.13.148 '/bin/sh -c '"'"'rm -f -r /tmp/ansible-tmp-1707410046.1299489-3264870-110034336375266/ > /dev/null 2>&1 && sleep 0'"'"''
<10.15.13.148> (0, b'', b'')
changed: [ANT3CASAPPS01] => {
    "changed": true,
    "cmd": [
        "ls",
        "-la",
        "/ibm/IBM-CAS/WebSphere/AppServer/profiles/AppSrv01/installedApps/ANT2CASAPPS01Node01Cell"
    ],
    "delta": "0:00:00.330385",
    "end": "2024-02-08 20:35:23.555811",
    "invocation": {
        "module_args": {
            "_raw_params": "ls -la /ibm/IBM-CAS/WebSphere/AppServer/profiles/AppSrv01/installedApps/ANT2CASAPPS01Node01Cell",
            "_uses_shell": false,
            "argv": null,
            "chdir": null,
            "creates": null,
            "executable": null,
            "removes": null,
            "stdin": null,
            "stdin_add_newline": true,
            "strip_empty_ends": true,
            "warn": false
        }
    },
    "rc": 0,
    "start": "2024-02-08 20:35:23.225426",
    "stderr": "",
    "stderr_lines": [],
    "stdout": "total 12\ndrwxrwxr-x 3 itdevtra itdevtra 4096 Feb  8 17:42 .\ndrwxrwxrwx 7 root     root     4096 Feb  7 16:19 ..\ndrwxrwxr-x 3 itdevtra itdevtra 4096 Feb  8 16:39 WFS.ear",
    "stdout_lines": [
        "total 12",
        "drwxrwxr-x 3 itdevtra itdevtra 4096 Feb  8 17:42 .",
        "drwxrwxrwx 7 root     root     4096 Feb  7 16:19 ..",
        "drwxrwxr-x 3 itdevtra itdevtra 4096 Feb  8 16:39 WFS.ear"
    ]
}

TASK [IBPS-deployment : Display ls -la result] *********************************
task path: /ansible/GITHUB_RUNNER/actions-runner10/_work/ibps-was-ansible-cd/ibps-was-ansible-cd/roles/IBPS-deployment/tasks/main.yml:37
ok: [ANT3CASAPPS01] => {
    "ls_result.stdout_lines": [
        "total 12",
        "drwxrwxr-x 3 itdevtra itdevtra 4096 Feb  8 17:42 .",
        "drwxrwxrwx 7 root     root     4096 Feb  7 16:19 ..",
        "drwxrwxr-x 3 itdevtra itdevtra 4096 Feb  8 16:39 WFS.ear"
    ]
}
