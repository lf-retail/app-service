#!/bin/bash

Profile_home="$1"
backup_location="$2"

# Find the latest backup directory with date and time
latest_backup=$(ls -td "$backup_location"/backup-* | head -n 1)

if [ -z "$latest_backup" ]; then
    echo "No backup directories found."
    exit 1
fi

echo "Latest backup directory: $latest_backup"

# Read the content of release.txt from the latest backup directory
release_content=$(cat "$latest_backup/release/release.txt" 2>/dev/null)

# Print the content of release_content
echo "$release_content"

# Iterate through each line in release_content
while IFS=, read -r app_name app_targeted_location; do
    # Check if both app_name and app_targeted_location are not empty
    if [ -n "$app_name" ] && [ -n "$app_targeted_location" ]; then
        # Construct paths for old deployment files in the latest backup directory
        backup_path="$latest_backup/$app_name"

        # Check if the backup directory for the application exists
        if [ -d "$backup_path" ]; then
            # Copy backup files to targeted location
            cp -r "$backup_path" "$app_targeted_location"

            # Print information about the rollback
            echo "Rollback: $app_name - $backup_path -> $app_targeted_location"
        else
            echo "Backup directory not found for $app_name."
        fi
    fi
done <<< "$release_content"
