name: release-was-warfileinstall
run-name: release-was-warfileinstall-${{ github.event.inputs.release_version }}

permissions:
  id-token: write
  contents: write
  security-events: write
  actions: read
  pull-requests: write

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version to deploy'
        required: true 
        type: string
      war_file_path:
        description: 'Path to the WAR file on the target server'
        required: true
        type: string
        default: '/ibm/IBM/WebSphere/AppServer/profiles/AppSrv01/installedApps/antibpsapp1Cell01/KYC_Remediation.war'
      war_file_name:
        description: 'Name of the WAR file'
        required: true
        type: string
        default: 'KYC_Remediation.war'
      app_name:
        description: 'Name of the deployed application'
        required: true
        type: string
        default: 'KYC_Remediation_war'
      context_root:
        description: 'Context root of the deployed application'
        required: true
        type: string
        default: '/KYC_Remediation'
      environment:
        description: 'Target environment'
        required: true
        type: string
        default: 'UAT209'

jobs:
  IBPS-warfileinstall:
    uses: rakbank-internal/enterprise-reusable-workflows/.github/workflows/was-warfileinstall.yml@feature/optimum-deh-mcf-templates
    with:
      release_version: ${{ github.event.inputs.release_version }}
      war_file_path: ${{ github.event.inputs.war_file_path }}
      war_file_name: ${{ github.event.inputs.war_file_name }}
      app_name: ${{ github.event.inputs.app_name }}
      context_root: ${{ github.event.inputs.context_root }}
      environment: ${{ github.event.inputs.environment }}
    secrets:
      TOKEN_GITHUB: ${{ secrets.TOKEN_GITHUB }}
      WAS_ADMIN_USER: ${{ secrets['WAS_ADMIN_USER_' + github.event.inputs.environment] }}
      WAS_ADMIN_PASSWORD: ${{ secrets['WAS_ADMIN_PASSWORD_' + github.event.inputs.environment] }}
      CELL_NAME: ${{ secrets['CELL_NAME_' + github.event.inputs.environment] }}
      CLUSTER_NAME: ${{ secrets['CLUSTER_NAME_' + github.event.inputs.environment] }}
      WAS_HOST: ${{ secrets['WAS_HOST_' + github.event.inputs.environment] }}
      WAS_PORT: ${{ secrets['WAS_PORT_' + github.event.inputs.environment] }}
      ansible_user: ${{ secrets['ansible_user_' + github.event.inputs.environment] }}
=================

name: 'was-warfileinstall'
description: 'was-warfileinstall'
inputs:
  release_version:
    description: 'Release version to deploy'
    required: true 
    type: string
  war_file_path:
    description: 'Path to the WAR file on the target server'
    required: true
    type: string
  war_file_name:
    description: 'Name of the WAR file'
    required: true
    type: string
  app_name:
    description: 'Name of the deployed application'
    required: true
    type: string
  context_root:
    description: 'Context root of the deployed application'
    required: true
    type: string
  TOKEN_GITHUB:
    description: 'GitHub token'
    required: true
    type: string
  USERNAME_GITHUB:
    description: 'GitHub username'
    required: true
    type: string    
  environment:
    description: 'Deployment environment'
    required: true
    type: string

secrets:
  TOKEN_GITHUB: 
    required: true
  USERNAME_GITHUB:
    required: true
  WAS_ADMIN_USER:
    required: true
  WAS_ADMIN_PASSWORD:
    required: true
  CELL_NAME:
    required: true
  CLUSTER_NAME:
    required: true
  WAS_HOST:
    required: true
  WAS_PORT:
    required: true
  ansible_user:
    required: true
    description: 'Ansible user for the deployment'

runs:
  using: "composite"
  steps:
    - name: Run Ansible Playbook
      env:
        TOKEN_GITHUB: ${{ inputs.TOKEN_GITHUB }}
        release_version: ${{ inputs.release_version }}
        war_file_path: ${{ inputs.war_file_path }}
        war_file_name: ${{ inputs.war_file_name }}
        app_name: ${{ inputs.app_name }}
        context_root: ${{ inputs.context_root }}
        USERNAME_GITHUB: ${{ inputs.USERNAME_GITHUB }}
        WAS_ADMIN_USER: ${{ secrets['WAS_ADMIN_USER_' + inputs.environment] }}
        WAS_ADMIN_PASSWORD: ${{ secrets['WAS_ADMIN_PASSWORD_' + inputs.environment] }}
        CELL_NAME: ${{ secrets['CELL_NAME_' + inputs.environment] }}
        CLUSTER_NAME: ${{ secrets['CLUSTER_NAME_' + inputs.environment] }}
        WAS_HOST: ${{ secrets['WAS_HOST_' + inputs.environment] }}
        WAS_PORT: ${{ secrets['WAS_PORT_' + inputs.environment] }}
        ansible_user: ${{ secrets['ansible_user_' + inputs.environment] }}
      run: |
        cd ${{ github.workspace }}
        ansible-playbook -vvv -b --extra-vars "target=target_was${{ inputs.environment }} destination=${{ github.workspace }} release_version=${release_version} war_file_path=${war_file_path} war_file_name=${war_file_name} app_name=${app_name} context_root=${context_root} TOKEN_GITHUB=${TOKEN_GITHUB} WAS_ADMIN_USER=${WAS_ADMIN_USER} WAS_ADMIN_PASSWORD=${WAS_ADMIN_PASSWORD} CELL_NAME=${CELL_NAME} CLUSTER_NAME=${CLUSTER_NAME} WAS_HOST=${WAS_HOST} WAS_PORT=${WAS_PORT}" ./playbook/was-warfileinstall.yml
      shell: bash
============

[all:vars]
ansible_user=itdevtra
ansible_ssh_port=22

[target_wasUAT209]
ANTIBPSAPP1 ansible_ssh_host={{ lookup('env', 'WAS_HOST_UAT209') }} ansible_host_port={{ lookup('env', 'WAS_PORT_UAT209') }}

[target_wasUAT210]
ANTIBPSAPP2 ansible_ssh_host={{ lookup('env', 'WAS_HOST_UAT210') }} ansible_host_port={{ lookup('env', 'WAS_PORT_UAT210') }}
===============

---
- name: was deploy warfileinstall in was
  hosts: '{{ target }}'
  become: yes
  become_user: '{{ ansible_user }}'

  tasks:
    - name: Set dynamic WAS_HOST and WAS_PORT
      set_fact:
        was_host: "{{ hostvars[inventory_hostname]['ansible_ssh_host'] }}"
        was_port: "{{ hostvars[inventory_hostname]['ansible_host_port'] }}"

    - name: Include environment-specific variables
      include_vars: "{{ hostvars[inventory_hostname].ansible_host_vars_file }}"
        
    - name: Include was-warfile-deploy
      include_role:
        name: was-warfile-deploy
        tasks_from: main.yml
      vars:
        github_token: "{{ lookup('env', 'TOKEN_GITHUB') }}"
        owner: "rakbank-internal"
        repo: "ibps-was-ansible-cd"
        branch: "IBPS-APP-ROLE"
        release_version: "{{ lookup('env', 'release_version') }}"
        Profile_home: "/ibm/IBM/Application/release"
        WAR_FILE_PATH: "{{ lookup('env', 'war_file_path') }}"
        WAR_FILE_NAME: "{{ lookup('env', 'war_file_name') }}"
        APP_NAME: "{{ lookup('env', 'app_name') }}"
        CONTEXT_ROOT: "{{ lookup('env', 'context_root') }}"
        ansible_user: "{{ lookup('env', 'ansible_user_' + environment) }}"
        WAS_HOST: "{{ was_host }}"
        WAS_PORT: "{{ was_port }}"
        WAS_ADMIN_USER: "{{ lookup('env', 'WAS_ADMIN_USER_' + environment) }}"
        WAS_ADMIN_PASSWORD: "{{ lookup('env', 'WAS_ADMIN_PASSWORD_' + environment) }}"
        CELL_NAME: "{{ lookup('env', 'CELL_NAME_' + environment) }}"
        CLUSTER_NAME: "{{ lookup('env', 'CLUSTER_NAME_' + environment) }}"
        WSADMIN: "/ibm/IBM/WebSphere/AppServer/profiles/AppSrv01/bin/wsadmin.sh"
