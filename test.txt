#!/bin/bash

# Extract release.zip on Target Server
sudo -u itdevtra tar -xzf "{{ Profile_home }}/{{ zip_file_name }}" -C "{{ Profile_home }}/"

# Run ls -la on the Target Server
sudo -u itdevtra ls -la "{{ Profile_home }}/release/" > ls_result.txt

# Display ls -la result
cat ls_result.txt

# Read release.txt content
release_content=$(sudo -u itdevtra cat "{{ Profile_home }}/release/release.txt")

# Copy application files to targeted location on Target Server
IFS=$'\n'
for line in $release_content; do
  source_file=$(echo $line | sed 's/\(.*\),\(.*\)/\1/')
  target_file=$(echo $line | sed 's/\(.*\),\(.*\)/\2/')
  sudo -u itdevtra cp "{{ Profile_home }}/release/$source_file" "{{ targeted_location }}/$target_file"
done

# Run ls -la on the Target Server
sudo -u itdevtra ls -la "{{ targeted_location }}" > ls_result_targeted.txt

# Display ls -la result
cat ls_result_targeted.txt
=======================

TASK [IBPS-deployment : Deploy Application] ************************************
task path: /ansible/GITHUB_RUNNER/actions-runner10/_work/IBPS-Deployment/IBPS-Deployment/roles/IBPS-deployment/tasks/main.yml:16
<10.15.13.148> ESTABLISH SSH CONNECTION FOR USER: itdevtra
<10.15.13.148> SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o StrictHostKeyChecking=no -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o 'User="itdevtra"' -o ConnectTimeout=30 -o ControlPath=/home/itdevtra/.ansible/cp/2b6c10444a 10.15.13.148 '/bin/sh -c '"'"'( umask 77 && mkdir -p "` echo /tmp `"&& mkdir /tmp/ansible-tmp-1705074046.0167649-2478402-166953595530371 && echo ansible-tmp-1705074046.0167649-2478402-166953595530371="` echo /tmp/ansible-tmp-1705074046.0167649-2478402-166953595530371 `" ) && sleep 0'"'"''
<10.15.13.148> (0, b'ansible-tmp-1705074046.0167649-2478402-166953595530371=/tmp/ansible-tmp-1705074046.0167649-2478402-166953595530371\n', b'')
Using module file /usr/lib/python3.6/site-packages/ansible/modules/commands/command.py
<10.15.13.148> PUT /home/itdevtra/.ansible/tmp/ansible-local-2478338m1pj22w3/tmp02jt3mgr TO /tmp/ansible-tmp-1705074046.0167649-2478402-166953595530371/AnsiballZ_command.py
<10.15.13.148> SSH: EXEC sftp -b - -C -o ControlMaster=auto -o ControlPersist=60s -o StrictHostKeyChecking=no -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o 'User="itdevtra"' -o ConnectTimeout=30 -o ControlPath=/home/itdevtra/.ansible/cp/2b6c10444a '[10.15.13.148]'
<10.15.13.148> (0, b'sftp> put /home/itdevtra/.ansible/tmp/ansible-local-2478338m1pj22w3/tmp02jt3mgr /tmp/ansible-tmp-1705074046.0167649-2478402-166953595530371/AnsiballZ_command.py\n', b'')
<10.15.13.148> ESTABLISH SSH CONNECTION FOR USER: itdevtra
<10.15.13.148> SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o StrictHostKeyChecking=no -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o 'User="itdevtra"' -o ConnectTimeout=30 -o ControlPath=/home/itdevtra/.ansible/cp/2b6c10444a 10.15.13.148 '/bin/sh -c '"'"'chmod u+x /tmp/ansible-tmp-1705074046.0167649-2478402-166953595530371/ /tmp/ansible-tmp-1705074046.0167649-2478402-166953595530371/AnsiballZ_command.py && sleep 0'"'"''
<10.15.13.148> (0, b'', b'')
<10.15.13.148> ESTABLISH SSH CONNECTION FOR USER: itdevtra
<10.15.13.148> SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o StrictHostKeyChecking=no -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o 'User="itdevtra"' -o ConnectTimeout=30 -o ControlPath=/home/itdevtra/.ansible/cp/2b6c10444a -tt 10.15.13.148 '/bin/sh -c '"'"'/usr/bin/python /tmp/ansible-tmp-1705074046.0167649-2478402-166953595530371/AnsiballZ_command.py && sleep 0'"'"''
<10.15.13.148> (1, b'\r\n{"changed": true, "end": "2024-01-12 19:41:23.655603", "stdout": "", "cmd": "cd /ansible/GITHUB_RUNNER/actions-runner10/_work/IBPS-Deployment/IBPS-Deployment && ./deploy-1.sh", "failed": true, "delta": "0:00:00.305123", "stderr": "/bin/sh: line 0: cd: /ansible/GITHUB_RUNNER/actions-runner10/_work/IBPS-Deployment/IBPS-Deployment: No such file or directory", "rc": 1, "invocation": {"module_args": {"creates": null, "executable": null, "_uses_shell": true, "strip_empty_ends": true, "_raw_params": "cd /ansible/GITHUB_RUNNER/actions-runner10/_work/IBPS-Deployment/IBPS-Deployment && ./deploy-1.sh", "removes": null, "argv": null, "warn": false, "chdir": null, "stdin_add_newline": true, "stdin": null}}, "start": "2024-01-12 19:41:23.350480", "msg": "non-zero return code"}\r\n', b'Shared connection to 10.15.13.148 closed.\r\n')
<10.15.13.148> Failed to connect to the host via ssh: Shared connection to 10.15.13.148 closed.
<10.15.13.148> ESTABLISH SSH CONNECTION FOR USER: itdevtra
<10.15.13.148> SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o StrictHostKeyChecking=no -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o 'User="itdevtra"' -o ConnectTimeout=30 -o ControlPath=/home/itdevtra/.ansible/cp/2b6c10444a 10.15.13.148 '/bin/sh -c '"'"'rm -f -r /tmp/ansible-tmp-1705074046.0167649-2478402-166953595530371/ > /dev/null 2>&1 && sleep 0'"'"''
<10.15.13.148> (0, b'', b'')
fatal: [ANT3CASAPPS01]: FAILED! => {
    "changed": true,
    "cmd": "cd /ansible/GITHUB_RUNNER/actions-runner10/_work/IBPS-Deployment/IBPS-Deployment && ./deploy-1.sh",
    "delta": "0:00:00.305123",
    "end": "2024-01-12 19:41:23.655603",
    "invocation": {
        "module_args": {
            "_raw_params": "cd /ansible/GITHUB_RUNNER/actions-runner10/_work/IBPS-Deployment/IBPS-Deployment && ./deploy-1.sh",
            "_uses_shell": true,
            "argv": null,
            "chdir": null,
            "creates": null,
            "executable": null,
            "removes": null,
            "stdin": null,
            "stdin_add_newline": true,
            "strip_empty_ends": true,
            "warn": false
        }
    },
    "msg": "non-zero return code",
    "rc": 1,
    "start": "2024-01-12 19:41:23.350480",
    "stderr": "/bin/sh: line 0: cd: /ansible/GITHUB_RUNNER/actions-runner10/_work/IBPS-Deployment/IBPS-Deployment: No such file or directory",
    "stderr_lines": [
        "/bin/sh: line 0: cd: /ansible/GITHUB_RUNNER/actions-runner10/_work/IBPS-Deployment/IBPS-Deployment: No such file or directory"
    ],
    "stdout": "",
    "stdout_lines": []
}
...ignoring
META: ran handlers
META: ran handlers

PLAY RECAP *********************************************************************
ANT3CASAPPS01              : ok=4    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=1   
