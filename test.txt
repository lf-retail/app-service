name: release-was-warfileinstall
run-name: release-was-warfileinstall-${{ github.event.inputs.release_version }}

permissions:
  id-token: write
  contents: write
  security-events: write
  actions: read
  pull-requests: write

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version to deploy'
        required: true 
        type: string
      war_file_path:
        description: 'Path to the WAR file on the target server'
        required: true
        type: string
        default: '/ibm/IBM/WebSphere/AppServer/profiles/AppSrv01/installedApps/antibpsapp1Cell01/KYC_Remediation.war'
      war_file_name:
        description: 'Name of the WAR file'
        required: true
        type: string
        default: 'KYC_Remediation.war'
      app_name:
        description: 'Name of the deployed application'
        required: true
        type: string
        default: 'KYC_Remediation_war'
      context_root:
        description: 'Context root of the deployed application'
        required: true
        type: string
        default: '/KYC_Remediation'
        
jobs:
  IBPS-warfileinstall:
    uses: rakbank-internal/enterprise-reusable-workflows/.github/workflows/was-warfileinstall.yml@feature/optimum-deh-mcf-templates
    with:
      release_version: ${{ github.event.inputs.release_version }}
      war_file_path: ${{ github.event.inputs.war_file_path }}
      war_file_name: ${{ github.event.inputs.war_file_name }}
      app_name: ${{ github.event.inputs.app_name }}
      context_root: ${{ github.event.inputs.context_root }}
    secrets:
      TOKEN_GITHUB: ${{ secrets.DEVOPS_WORKFLOW_TOKEN }}
      USERNAME_GITHUB: ${{ secrets.USERNAME_GITHUB }}

================================
- name: was deploy warfileinstall in was
  hosts: '{{ target }}'
  become: yes
  become_user: '{{ ansible_user }}'

  tasks:
    - name: Set dynamic WAS_HOST and WAS_PORT
      set_fact:
        was_host: "{{ hostvars[inventory_hostname]['ansible_ssh_host'] }}"
        was_port: "{{ hostvars[inventory_hostname]['ansible_host_port'] }}"

    - name: Include environment-specific variables
      include_vars: "{{ hostvars[inventory_hostname].ansible_host_vars_file }}"
        
    - name: Include was-warfile-deploy
      include_role:
        name:  was-warfile-deploy
        tasks_from: main.yml
      vars:
        github_token: "{{ lookup('env', 'TOKEN_GITHUB') }}"
        owner: "rakbank-internal"
        repo: "ibps-was-ansible-cd"
        branch: "IBPS-APP-ROLE"
        release_version: "{{ lookup('env', 'release_version') }}"
        Profile_home: "/ibm/IBM/Application/release"
        WAR_FILE_PATH:  "{{ lookup('env', 'war_file_path') }}"
        WAR_FILE_NAME:  "{{ lookup('env', 'war_file_name') }}"
        APP_NAME:  "{{ lookup('env', 'app_name') }}"
        CONTEXT_ROOT:  "{{ lookup('env', 'context_root') }}"
        WAS_HOST: "{{ was_host }}"
        WAS_PORT: "{{ was_port }}"
        WAS_ADMIN_USER: "{{ was_admin_user }}"
        WAS_ADMIN_PASSWORD: "{{ was_admin_password }}"
        CELL_NAME: "{{ cell_name }}"
        CLUSTER_NAME: "{{ cluster_name }}"
        WSADMIN: "/ibm/IBM/WebSphere/AppServer/profiles/AppSrv01/bin/wsadmin.sh"        
=========================
[all:vars]
ansible_user=itdevtra
ansible_ssh_port=22

[target_wasuat209]
ANTIBPSAPP1 ansible_ssh_host=10.15.11.209 ansible_host_port=8879 ansible_host_vars_file=vars/uat209.yml

#[target_wasuat210]
#ANTIBPSAPP2 ansible_ssh_host=10.15.11.210 ansible_host_port=8879 ansible_host_vars_file=vars/uat210.yml
=================

cell_name: "antibpsapp1Cell01"
cluster_name: "BPMCLUSTER"
ansible_user: "itdevtra"
was_admin_user: "deployer"
was_admin_password: "deployer@123"
================

name: was-warfileinstall-reusable-workflow

permissions:
  id-token: write
  contents: write
  security-events: write
  actions: read
  pull-requests: write

on:
  workflow_call:
    inputs:
      release_version:
        description: 'Release version to deploy'
        required: true 
        type: string
      war_file_path:
        description: 'Path to the WAR file on the target server'
        required: true
        type: string
      war_file_name:
        description: 'Name of the WAR file'
        required: true
        type: string
      app_name:
        description: 'Name of the deployed application'
        required: true
        type: string
      context_root:
        description: 'Context root of the deployed application'
        required: true
        type: string

    secrets:
      TOKEN_GITHUB: 
        required: true
      USERNAME_GITHUB:
        required: true

jobs:
  deploy:
    runs-on:
     group: rakbank-self-hosted-runner
     labels: dehitdevtra1

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Checkout roles repository
      uses: actions/checkout@v4
      with:
        repository: rakbank-internal/enterprise-ansible-roles
        token: ${{ secrets.TOKEN_GITHUB }}
        path: ansible-roles
        ref: Feature      
      
    - name: Checkout reusable code
      uses: actions/checkout@v4
      with:
        repository: rakbank-internal/enterprise-reusable-workflows
        ref: feature/optimum-deh-mcf-templates
        path: reusable-workflows
        token: ${{ secrets.TOKEN_GITHUB }}  

    - name: Make war-install-in-was.sh executable
      run: |
        chmod +x scripts/war-install-in-was.sh    

    - name: war file installation in WAS
      uses: ./reusable-workflows/.github/actions/was-warfileinstall
      with:
        release_version: ${{ inputs.release_version }}
        war_file_path: ${{ inputs.war_file_path }}
        war_file_name: ${{ inputs.war_file_name }}
        app_name: ${{ inputs.app_name }}
        context_root: ${{ inputs.context_root }}
        TOKEN_GITHUB: ${{ secrets.TOKEN_GITHUB }}
        USERNAME_GITHUB: ${{ secrets.USERNAME_GITHUB }}
=========================
name: 'was-warfileinstall'
description: 'was-warfileinstall'
inputs:
  release_version:
    description: 'Release version to deploy'
    required: true 
    type: string
  war_file_path:
    description: 'Path to the WAR file on the target server'
    required: true
    type: string
  war_file_name:
    description: 'Name of the WAR file'
    required: true
    type: string
  app_name:
    description: 'Name of the deployed application'
    required: true
    type: string
  context_root:
    description: 'Context root of the deployed application'
    required: true
    type: string
  TOKEN_GITHUB:
    description: 'GitHub token'
    required: true
    type: string
  USERNAME_GITHUB:
    description: 'GitHub username'
    required: true
    type: string    
  
runs:
  using: "composite"
  steps:
    - name: Run Ansible Playbook
      env:
        TOKEN_GITHUB: ${{ inputs.TOKEN_GITHUB }}
        release_version: ${{ inputs.release_version }}
        war_file_path: ${{ inputs.war_file_path }}
        war_file_name: ${{ inputs.war_file_name }}
        app_name: ${{ inputs.app_name }}
        context_root: ${{ inputs.context_root }}
        USERNAME_GITHUB: ${{ inputs.USERNAME_GITHUB }}
      run: |
        cd ${{ github.workspace }}
        ansible-playbook -vvv -b --extra-vars "target=target_wasuat209 destination=${{ github.workspace }} release_version=${release_version} war_file_path=${war_file_path} war_file_name=${war_file_name} app_name=${app_name} context_root=${context_root} TOKEN_GITHUB=${TOKEN_GITHUB}" ./playbook/was-warfileinstall.yml
      shell: bash   
====================

name: release-was-warfileinstall
run-name: release-was-warfileinstall-${{ github.event.inputs.release_version }}

permissions:
  id-token: write
  contents: write
  security-events: write
  actions: read
  pull-requests: write

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Release version to deploy'
        required: true 
        type: string
      war_file_path:
        description: 'Path to the WAR file on the target server'
        required: true
        type: string
        default: '/ibm/IBM/WebSphere/AppServer/profiles/AppSrv01/installedApps/antibpsapp1Cell01/KYC_Remediation.war'
      war_file_name:
        description: 'Name of the WAR file'
        required: true
        type: string
        default: 'KYC_Remediation.war'
      app_name:
        description: 'Name of the deployed application'
        required: true
        type: string
        default: 'KYC_Remediation_war'
      context_root:
        description: 'Context root of the deployed application'
        required: true
        type: string
        default: '/KYC_Remediation'
      target_env:
        description: 'Target environment (UAT209, UAT210, etc.)'
        required: true
        type: string

jobs:
  deploy:
    runs-on: self-hosted

    steps:
    - name: Set environment-specific secrets
      id: set-env-secrets
      run: |
        echo "ANSIBLE_SSH_HOST=${{ secrets.ANSIBLE_SSH_HOST }}" >> $GITHUB_ENV
        echo "ANSIBLE_HOST_PORT=${{ secrets.ANSIBLE_HOST_PORT }}" >> $GITHUB_ENV
        echo "WAS_ADMIN_USER=${{ secrets.WAS_ADMIN_USER }}" >> $GITHUB_ENV
        echo "WAS_ADMIN_PASSWORD=${{ secrets.WAS_ADMIN_PASSWORD }}" >> $GITHUB_ENV
        echo "CELL_NAME=${{ secrets.CELL_NAME }}" >> $GITHUB_ENV
        echo "CLUSTER_NAME=${{ secrets.CLUSTER_NAME }}" >> $GITHUB_ENV

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Ansible Playbook
      run: |
        ansible-playbook -vvv -b --extra-vars "target=target_was${{ inputs.target_env }}" \
          release_version=${{ inputs.release_version }} \
          war_file_path=${{ inputs.war_file_path }} \
          war_file_name=${{ inputs.war_file_name }} \
          app_name=${{ inputs.app_name }} \
          context_root=${{ inputs.context_root }}" \
          ANSIBLE_SSH_HOST=${{ env.ANSIBLE_SSH_HOST }}" \
          ANSIBLE_HOST_PORT=${{ env.ANSIBLE_HOST_PORT }}" \
          WAS_ADMIN_USER=${{ env.WAS_ADMIN_USER }}" \
          WAS_ADMIN_PASSWORD=${{ env.WAS_ADMIN_PASSWORD }}" \
          CELL_NAME=${{ env.CELL_NAME }}" \
          CLUSTER_NAME=${{ env.CLUSTER_NAME }}" \
          ./playbook/was-warfileinstall.yml
      env:
        TOKEN_GITHUB: ${{ secrets.DEVOPS_WORKFLOW_TOKEN }}
        USERNAME_GITHUB: ${{ secrets.USERNAME_GITHUB }}
==================

[all:vars]
ansible_user=itdevtra
ansible_ssh_port=22

[target_wasUAT209]
ANTIBPSAPP1 ansible_ssh_host={{ ANSIBLE_SSH_HOST }} ansible_host_port={{ ANSIBLE_HOST_PORT }}

[target_wasUAT210]
ANTIBPSAPP1 ansible_ssh_host={{ ANSIBLE_SSH_HOST }} ansible_host_port={{ ANSIBLE_HOST_PORT }}
=================

---
- name: WAS Warfile Install
  hosts: '{{ target }}'
  become: yes
  become_user: '{{ ansible_user }}'

  tasks:
    - name: Include environment-specific variables
      include_vars:
        dir: vars
        name: "{{ target_env }}"

    - name: Include was-warfile-deploy
      include_role:
        name: was-warfile-deploy
        tasks_from: main.yml
      vars:
        github_token: "{{ lookup('env', 'TOKEN_GITHUB') }}"
        owner: "rakbank-internal"
        repo: "ibps-was-ansible-cd"
        branch: "IBPS-APP-ROLE"
        release_version: "{{ release_version }}"
        Profile_home: "/ibm/IBM/Application/release"
        WAR_FILE_PATH: "{{ war_file_path }}"
        WAR_FILE_NAME: "{{ war_file_name }}"
        APP_NAME: "{{ app_name }}"
        CONTEXT_ROOT: "{{ context_root }}"
        WAS_HOST: "{{ ANSIBLE_SSH_HOST }}"
        WAS_PORT: "{{ ANSIBLE_HOST_PORT }}"
        WAS_ADMIN_USER: "{{ WAS_ADMIN_USER }}"
        WAS_ADMIN_PASSWORD: "{{ WAS_ADMIN_PASSWORD }}"
        CELL_NAME: "{{ CELL_NAME }}"
        CLUSTER_NAME: "{{ CLUSTER_NAME }}"
        WSADMIN: "/ibm/IBM/WebSphere/AppServer/profiles/AppSrv01/bin/wsadmin.sh"

====================

Hi Hritik,

You already done the below steps to move the release.zip into GitHub Releases But now you sent in different way. So Please follow the below step for IBPS application deployment

Create the "release" directory.
Inside the "release" directory, generate a "release.txt" file that lists the application name and its intended location in CSV format.
Additionally, place all application files into the "release" directory.
Compress the "release" directory to create "release.zip".
Finally, the Newgen team should upload the "release.zip" file to GitHub Releases.
Please proceed accordingly. Let me know if you need any further clarification.

Please refer to the below screenshot for the previous releases. We need to follow the same process to move the release.zip file, ensuring the GitHub Releases tag name is different this time.

