#!/bin/bash
 
# Server details
WAS_HOST="$1"
WAS_PORT="$2"
WAS_ADMIN_USER="$3"
WAS_ADMIN_PASSWORD="$4"
 
# WAR file and application details
WAR_FILE_PATH="$5"
APP_NAME="$6"
CONTEXT_ROOT="$7"
CELL_NAME="$8"
CLUSTER_NAME="$9"
 
# Path to wsadmin.sh
WSADMIN="${10}"
WAR_FILE_NAME="${11}"

# Define the shared libraries array
shared_libs=("ibps_library" "omnidocs_library" "wfs_library")
 
# Create a new file for the Jython script
WSADMIN_SCRIPT="wsadmin_script.jy"
 
# Write the initial part of the Jython script to the file
cat <<EOF >$WSADMIN_SCRIPT
import time
import sys

# Check if the application is already running
if '${APP_NAME}' in AdminControl.queryNames('type=Application,*').splitlines():
    print 'Application ${APP_NAME} is already running. Stopping it...'
    app_managers = AdminControl.queryNames('type=ApplicationManager,*').splitlines()
    for app_manager in app_managers:
        AdminControl.invoke(app_manager, 'stopApplication', '${APP_NAME}', '[${CELL_NAME},${CLUSTER_NAME}]')
    print 'Application ${APP_NAME} stop command issued.'

# Wait for the application to stop
while '${APP_NAME}' in AdminControl.queryNames('type=Application,*').splitlines():
    print 'Waiting for application %s to stop...' % '${APP_NAME}'
    time.sleep(30)

print 'Application %s is not running.' % '${APP_NAME}'

# Uninstall the application if it already exists
if '${APP_NAME}' in AdminApp.list().splitlines():
    print 'Application %s already exists. Removing...' % '${APP_NAME}'
    result = AdminApp.uninstall('${APP_NAME}')
    if result != '':
        print 'Failed to uninstall application ' + '${APP_NAME}' + '. Error: ' + result
        raise Exception('Failed to uninstall application ' + '${APP_NAME}')
    else:
        AdminConfig.save()
        print 'Application %s removed.' % '${APP_NAME}'

# Install the application
result = AdminApp.install("${WAR_FILE_PATH}", '[ -nopreCompileJSPs -distributeApp -nouseMetaDataFromBinary -nodeployejb -appname ${APP_NAME} -createMBeansForResources -noreloadEnabled -nodeployws -validateinstall warn -noprocessEmbeddedConfig -filepermission .*\.dll=755#.*\.so=755#.*\.a=755#.*\.sl=755 -noallowDispatchRemoteInclude -noallowServiceRemoteInclude -asyncRequestDispatchType DISABLED -nouseAutoLink -noenableClientModule -clientMode isolated -novalidateSchema -contextroot ${CONTEXT_ROOT} -MapModulesToServers [[ ${WAR_FILE_NAME} ${WAR_FILE_NAME},WEB-INF/web.xml WebSphere:cell=${CELL_NAME},cluster=${CLUSTER_NAME} ]] -MapSharedLibForMod [[ ${APP_NAME} META-INF/application.xml wfs_library+omnidocs_library+ibps_library ]]')

if result != '':
    print 'Failed to install application ' + '${APP_NAME}' + '. Error: ' + result
    raise Exception('Failed to install application ' + '${APP_NAME}')
    
# Set the class loader policy to PARENT_LAST
dep = AdminConfig.getid('/Deployment:${APP_NAME}/')
depObject = AdminConfig.showAttribute(dep, 'deployedObject')

modules = AdminConfig.showAttribute(depObject, 'modules')
for module in modules[1:-1].split():
    if AdminConfig.showAttribute(module, 'uri') == 'KYC_Remediation.war':
        warClassldr = AdminConfig.showAttribute(module, 'classloader')
        AdminConfig.modify(warClassldr, [['mode', 'PARENT_LAST']])
        break

# Save configuration and add a delay before starting the application
AdminConfig.save()
time.sleep(60)

# Start the application on each node in the cluster
print 'Starting application ${APP_NAME}'
AdminControl.invoke('WebSphere:name=ApplicationManager,process=BPMMBR01,platform=proxy,node=antibpsapp1Node01,version=8.5.5.25,type=ApplicationManager,mbeanIdentifier=ApplicationManager,cell=${CELL_NAME},spec=1.0', 'startApplication', '${APP_NAME}')
AdminControl.invoke('WebSphere:name=ApplicationManager,process=BPMMBR02,platform=proxy,node=antibpsapp2Node01,version=8.5.5.25,type=ApplicationManager,mbeanIdentifier=ApplicationManager,cell=${CELL_NAME},spec=1.0', 'startApplication', '${APP_NAME}')
print 'Application ${APP_NAME} started.'
EOF

# Execute the script with wsadmin
$WSADMIN -lang jython -conntype SOAP -host $WAS_HOST -port $WAS_PORT -user $WAS_ADMIN_USER -password $WAS_ADMIN_PASSWORD -f $WSADMIN_SCRIPT
======================================

TASK [was-warfile-deploy : Run war-install-in-was.sh on Target Server] *********
task path: /ansible/GITHUB_RUNNER/actions-runner10/_work/ibps-was-ansible-cd/ibps-was-ansible-cd/ansible-roles/was-warfile-deploy/tasks/main.yml:11
<10.15.11.209> ESTABLISH SSH CONNECTION FOR USER: itdevtra
<10.15.11.209> SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o StrictHostKeyChecking=no -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o 'User="itdevtra"' -o ConnectTimeout=30 -o ControlPath=/home/itdevtra/.ansible/cp/9d82de7b55 10.15.11.209 '/bin/sh -c '"'"'( umask 77 && mkdir -p "` echo /tmp `"&& mkdir /tmp/ansible-tmp-1717738416.3194215-1622767-176286225567794 && echo ansible-tmp-1717738416.3194215-1622767-176286225567794="` echo /tmp/ansible-tmp-1717738416.3194215-1622767-176286225567794 `" ) && sleep 0'"'"''
<10.15.11.209> (0, b'ansible-tmp-1717738416.3194215-1622767-176286225567794=/tmp/ansible-tmp-1717738416.3194215-1622767-176286225567794\n', b'')
Using module file /usr/lib/python3.6/site-packages/ansible/modules/commands/command.py
<10.15.11.209> PUT /home/itdevtra/.ansible/tmp/ansible-local-1622724ap3rhng2/tmpyf399rh6 TO /tmp/ansible-tmp-1717738416.3194215-1622767-176286225567794/AnsiballZ_command.py
<10.15.11.209> SSH: EXEC sftp -b - -C -o ControlMaster=auto -o ControlPersist=60s -o StrictHostKeyChecking=no -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o 'User="itdevtra"' -o ConnectTimeout=30 -o ControlPath=/home/itdevtra/.ansible/cp/9d82de7b55 '[10.15.11.209]'
<10.15.11.209> (0, b'sftp> put /home/itdevtra/.ansible/tmp/ansible-local-1622724ap3rhng2/tmpyf399rh6 /tmp/ansible-tmp-1717738416.3194215-1622767-176286225567794/AnsiballZ_command.py\n', b'')
<10.15.11.209> ESTABLISH SSH CONNECTION FOR USER: itdevtra
<10.15.11.209> SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o StrictHostKeyChecking=no -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o 'User="itdevtra"' -o ConnectTimeout=30 -o ControlPath=/home/itdevtra/.ansible/cp/9d82de7b55 10.15.11.209 '/bin/sh -c '"'"'chmod u+x /tmp/ansible-tmp-1717738416.3194215-1622767-176286225567794/ /tmp/ansible-tmp-1717738416.3194215-1622767-176286225567794/AnsiballZ_command.py && sleep 0'"'"''
<10.15.11.209> (0, b'', b'')
<10.15.11.209> ESTABLISH SSH CONNECTION FOR USER: itdevtra
<10.15.11.209> SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o StrictHostKeyChecking=no -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o 'User="itdevtra"' -o ConnectTimeout=30 -o ControlPath=/home/itdevtra/.ansible/cp/9d82de7b55 -tt 10.15.11.209 '/bin/sh -c '"'"'/usr/bin/python /tmp/ansible-tmp-1717738416.3194215-1622767-176286225567794/AnsiballZ_command.py && sleep 0'"'"''
<10.15.11.209> (1, b'\r\n{"changed": true, "end": "2024-06-07 09:39:44.677735", "stdout": "WASX7209I: Connected to process \\"dmgr\\" on node antibpsapp1CellManager01 using SOAP connector;  The type of process is: DeploymentManager\\nApplication KYC_Remediation_war is not running.\\nApplication KYC_Remediation_war already exists. Removing...\\nADMA5017I: Uninstallation of KYC_Remediation_war started.\\nADMA5104I: The server index entry for WebSphere:cell=antibpsapp1Cell01,node=antibpsapp2Node01+WebSphere:cell=antibpsapp1Cell01,node=antibpsapp1Node01 is updated successfully.\\nADMA5102I: The configuration data for KYC_Remediation_war from the configuration repository is deleted successfully.\\nADMA5011I: The cleanup of the temp directory for application KYC_Remediation_war is complete.\\nADMA5106I: Application KYC_Remediation_war uninstalled successfully.\\nApplication KYC_Remediation_war removed.\\nWASX7327I: Contents of was.policy file:\\n //\\n// Template policy file for enterprise application.\\n// Extra permissions can be added if required by the enterprise application.\\n//\\n// NOTE: Syntax errors in the policy files will cause the enterprise application FAIL to start.\\n//       Extreme care should be taken when editing these policy files. It is advised to use\\n//       the policytool provided by the JDK for editing the policy files\\n//       (WAS_HOME/java/jre/bin/policytool). \\n//\\n\\ngrant codeBase \\"file:${application}\\" {\\n};\\n\\ngrant codeBase \\"file:${jars}\\" {\\n};\\n\\ngrant codeBase \\"file:${connectorComponent}\\" {\\n};\\n\\ngrant codeBase \\"file:${webComponent}\\" {\\n};\\n\\ngrant codeBase \\"file:${ejbComponent}\\" {\\n};\\n\\n\\nADMA5016I: Installation of KYC_Remediation_war started.\\nADMA5067I: Resource validation for application KYC_Remediation_war completed successfully.\\nADMA5058I: Application and module versions are validated with versions of deployment targets.\\nADMA5005I: The application KYC_Remediation_war is configured in the WebSphere Application Server repository.\\nADMA5005I: The application KYC_Remediation_war is configured in the WebSphere Application Server repository.\\nADMA5081I: The bootstrap address for client module is configured in the WebSphere Application Server repository.\\nADMA5053I: The library references for the installed optional package are created.\\nADMA5005I: The application KYC_Remediation_war is configured in the WebSphere Application Server repository.\\nADMA5001I: The application binaries are saved in /ibm/IBM/WebSphere/AppServer/profiles/Dmgr01/wstemp/Script18ff1342899/workspace/cells/antibpsapp1Cell01/applications/KYC_Remediation_war.ear/KYC_Remediation_war.ear\\nADMA5005I: The application KYC_Remediation_war is configured in the WebSphere Application Server repository.\\nSECJ0400I: Successfully updated the application KYC_Remediation_war with the appContextIDForSecurity information.\\nADMA5005I: The application KYC_Remediation_war is configured in the WebSphere Application Server repository.\\nADMA5005I: The application KYC_Remediation_war is configured in the WebSphere Application Server repository.\\nADMA5113I: Activation plan created successfully.\\nADMA5011I: The cleanup of the temp directory for application KYC_Remediation_war is complete.\\nADMA5013I: Application KYC_Remediation_war installed successfully.\\nStarting application KYC_Remediation_war\\nWASX7017E: Exception received while running file \\"wsadmin_script.jy\\"; exception information: javax.management.MBeanException\\ncom.ibm.ws.exception.RedundantStateChangeException: Composition Unit WebSphere:cuname=KYC_Remediation_war,cuedition=BASE already started", "cmd": "cd /ibm/IBM/Application/release/release.2.0.0.5 && ./war-install-in-was.sh 10.15.11.209 8879 *** *** /ibm/IBM/WebSphere/AppServer/profiles/AppSrv01/installedApps/antibpsapp1Cell01/KYC_Remediation.war KYC_Remediation_war /KYC_Remediation antibpsapp1Cell01 BPMCLUSTER /ibm/IBM/WebSphere/AppServer/profiles/AppSrv01/bin/wsadmin.sh KYC_Remediation.war", "failed": true, "delta": "0:01:50.610422", "stderr": "", "rc": 105, "invocation": {"module_args": {"creates": null, "executable": null, "_uses_shell": true, "strip_empty_ends": true, "_raw_params": "cd /ibm/IBM/Application/release/release.2.0.0.5 && ./war-install-in-was.sh 10.15.11.209 8879 *** *** /ibm/IBM/WebSphere/AppServer/profiles/AppSrv01/installedApps/antibpsapp1Cell01/KYC_Remediation.war KYC_Remediation_war /KYC_Remediation antibpsapp1Cell01 BPMCLUSTER /ibm/IBM/WebSphere/AppServer/profiles/AppSrv01/bin/wsadmin.sh KYC_Remediation.war", "removes": null, "argv": null, "warn": false, "chdir": null, "stdin_add_newline": true, "stdin": null}}, "start": "2024-06-07 09:37:54.067313", "msg": "non-zero return code"}\r\n', b'Shared connection to 10.15.11.209 closed.\r\n')
        "",
        "grant codeBase \"file:${application}\" {",
        "};",
        "",
        "grant codeBase \"file:${jars}\" {",
        "};",
        "",
        "grant codeBase \"file:${connectorComponent}\" {",
        "};",
        "",
        "grant codeBase \"file:${webComponent}\" {",
        "};",
        "",
        "grant codeBase \"file:${ejbComponent}\" {",
        "};",
        "",
        "",
        "ADMA5016I: Installation of KYC_Remediation_war started.",
        "ADMA5067I: Resource validation for application KYC_Remediation_war completed successfully.",
        "ADMA5058I: Application and module versions are validated with versions of deployment targets.",
        "ADMA5005I: The application KYC_Remediation_war is configured in the WebSphere Application Server repository.",
        "ADMA5005I: The application KYC_Remediation_war is configured in the WebSphere Application Server repository.",
        "ADMA5081I: The bootstrap address for client module is configured in the WebSphere Application Server repository.",
        "ADMA5053I: The library references for the installed optional package are created.",
        "ADMA5005I: The application KYC_Remediation_war is configured in the WebSphere Application Server repository.",
        "ADMA5001I: The application binaries are saved in /ibm/IBM/WebSphere/AppServer/profiles/Dmgr01/wstemp/Script18ff1342899/workspace/cells/antibpsapp1Cell01/applications/KYC_Remediation_war.ear/KYC_Remediation_war.ear",
        "ADMA5005I: The application KYC_Remediation_war is configured in the WebSphere Application Server repository.",
        "SECJ0400I: Successfully updated the application KYC_Remediation_war with the appContextIDForSecurity information.",
        "ADMA5005I: The application KYC_Remediation_war is configured in the WebSphere Application Server repository.",
        "ADMA5005I: The application KYC_Remediation_war is configured in the WebSphere Application Server repository.",
        "ADMA5113I: Activation plan created successfully.",
        "ADMA5011I: The cleanup of the temp directory for application KYC_Remediation_war is complete.",
        "ADMA5013I: Application KYC_Remediation_war installed successfully.",
        "Starting application KYC_Remediation_war",
        "WASX7017E: Exception received while running file \"wsadmin_script.jy\"; exception information: javax.management.MBeanException",
        "com.ibm.ws.exception.RedundantStateChangeException: Composition Unit WebSphere:cuname=KYC_Remediation_war,cuedition=BASE already started"
    ]
}
...ignoring
