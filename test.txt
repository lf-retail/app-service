- name: Download zip from GitHub packages on Runner
  delegate_to: localhost
  run_once: true
  get_url:
    url: "{{ zip_file_url }}"
    dest: "/tmp/{{ zip_file_name }}"
    headers:
      Authorization: "token {{ TOKEN_GITHUB }}"

- name: Copy zip to Target Server
  copy:
    src: "/tmp/{{ zip_file_name }}"
    dest: "{{ Profile_home }}/{{ zip_file_name }}"
    
- name: Check if deploy.sh already exists on Target Server
  stat:
    path: "{{ Profile_home }}/deploy.sh"
  become: yes
  become_user: "{{ ansible_user }}"
  register: deploy_file_status    

- name: Copy deploy.sh to Target Server
  copy:
    src: "{{ github.workspace }}/deploy.sh"  # Update the path to your deploy.sh file
    dest: "{{ Profile_home }}/deploy.sh"
    mode: '0755'  # Ensure execute permissions
  when: deploy_file_status.stat.exists == False    

- name: List contents of the directory after copying deploy.sh
  command: ls -al "{{ Profile_home }}"
  become: yes
  become_user: "{{ ansible_user }}"

- name: Run deploy.sh on Target Server
  become: yes
  become_user: "{{ ansible_user }}"
  shell: 'cd {{ Profile_home }} && ./deploy.sh'
  register: deploy_result
  ignore_errors: yes
