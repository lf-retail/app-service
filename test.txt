---
- name: Download zip from GitHub packages on Runner
  delegate_to: localhost
  run_once: true
  get_url:
    url: "{{ zip_file_url }}"
    dest: "/tmp/{{ zip_file_name }}"
    headers:
      Authorization: "token {{ github_token }}"

- name: Copy release.zip to Target Server
  copy:
    src: "/tmp/{{ zip_file_name }}"
    dest: "{{ Profile_home }}/{{ zip_file_name }}"

- name: Run ls -la on the Target Server
  become: true
  become_user: itdevtra
  command: "ls -la {{ Profile_home }}"
  register: ls_result    

- name: Display ls -la result
  debug:
    var: ls_result.stdout_lines  
    
- name: Extract release.zip on Target Server
  become: true
  become_user: itdevtra
  unarchive:
    src: "{{ Profile_home }}/{{ zip_file_name }}"
    dest: "{{ Profile_home }}/"
    remote_src: yes
  register: unarchive_result  

- name: Run ls -la on the Target Server
  become: true
  become_user: itdevtra
  command: "ls -la {{ Profile_home }}"
  register: ls_result    

- name: Display ls -la result
  debug:
    var: ls_result.stdout_lines   

- name: Read release.txt content
  become: true
  become_user: itdevtra
  shell: cat "{{ Profile_home }}/release/release.txt"
  register: release_content

- name: Copy application files to targeted location on Target Server
  become: true
  become_user: itdevtra
  command: "cd {{ Profile_home }}/release && cp {{ item['src'] }} {{ item['target'] }}"
  loop: "{{ release_content.stdout_lines | map('regex_replace', '^(.+?),(.+)$', '\\1 src=\\1 target=\\2') | map('from_yaml') | list }}"
  when: release_content.stdout_lines | length > 0
======================
TASK [IBPS-deployment : Copy application files to targeted location on Target Server] ***
task path: /ansible/GITHUB_RUNNER/actions-runner10/_work/IBPS-Deployment/IBPS-Deployment/roles/IBPS-deployment/tasks/main.yml:51
fatal: [ANT3CASAPPS01]: FAILED! => {
    "msg": "The task includes an option with an undefined variable. The error was: 'ansible.utils.unsafe_proxy.AnsibleUnsafeText object' has no attribute 'src'\n\nThe error appears to be in '/ansible/GITHUB_RUNNER/actions-runner10/_work/IBPS-Deployment/IBPS-Deployment/roles/IBPS-deployment/tasks/main.yml': line 51, column 3, but may\nbe elsewhere in the file depending on the exact syntax problem.\n\nThe offending line appears to be:\n\n\n- name: Copy application files to targeted location on Target Server\n  ^ here\n"
}

PLAY RECAP *********************************************************************
ANT3CASAPPS01              : ok=9    changed=3    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0   

Error: Process completed with exit code 2.
