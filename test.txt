---
- name: Download and Move Release
  hosts: localhost
  gather_facts: yes
  tasks:
    - name: Download release.zip from GitHub Packages
      github_release:
        owner: your-github-username
        repo: your-repo
        asset_name: release.zip
        token: "{{ TOKEN_GITHUB }}"
        dest: "{{ github.workspace }}/release.zip"
      delegate_to: localhost
      register: download_result

    - name: Fail if download fails
      fail:
        msg: "Failed to download release.zip from GitHub Packages"
      when: not download_result.changed

    - name: Create temp directory on target server
      ansible.builtin.shell:
        cmd: 'mkdir -p /path/on/target/server/temp_directory'
      delegate_to: your-target-server

    - name: Transfer release.zip to target server temp directory
      ansible.builtin.copy:
        src: "{{ github.workspace }}/release.zip"
        dest: "/path/on/target/server/temp_directory/release.zip"
      delegate_to: localhost


==================

#!/bin/bash

# Step 1: Extract release.zip in the temp directory on the targeted server
unzip -q /path/on/target/server/temp_directory/release.zip -d /path/on/target/server/temp_directory/

# Step 2: Read release.txt content on the targeted server
while IFS=, read -r file target; do
    # Step 3: Copy application files to targeted location on the targeted server
    cp "/path/on/target/server/temp_directory/$file" "$target"
done < /path/on/target/server/temp_directory/release.txt

echo "Deployment completed successfully."

============================
defauls
---
ibps_server: 10.15.13.148:9043
github_token: "{{ lookup('env', 'TOKEN_GITHUB') }}"
zip_file_url: "https://maven.pkg.github.com/rakbank-internal/IBPS-Deployment/Rak/IBPS/release/2.0.0/release-2.0.0.zip"
zip_file_name: "{{ zip_file_url | basename }}"
Profile_home: "/ibm/IBM-CAS/WebSphere/AppServer/profiles/AppSrv01/bin"
...
task
---
    - name: Download zip from GitHub packages on Runner
      delegate_to: localhost
      run_once: true
      get_url:
        url: "{{ zip_file_url }}"
        dest: "/tmp/{{ zip_file_name }}"
        headers:
          Authorization: "token {{ github_token }}"

    - name: Copy zip to Target Server
      copy:
        src: "/tmp/{{ zip_file_name }}"
        dest: "{{ Profile_home }}/{{ zip_file_name }}

    - name: Clean up zip file from Runner
      delegate_to: localhost
      file:
        path: "/tmp/{{ zip_file_name }}"
        state: absent
      run_once: true          
      
    - name: Deploy Application
      delegate_to: localhost
      shell: 'cd {{ destination }} && ./deploy-1.sh'
      register: deploy_result
      ignore_errors: yes
==================
#!/bin/bash

# Assuming release.zip is already on the targeted server

# Step 1: Extract release.zip in the temp directory within Profile_home
unzip -q "{{ Profile_home }}/{{ zip_file_name }}" -d "{{ Profile_home }}/temp_directory/"

# Step 2: Read release.txt content
while IFS=, read -r file target; do
    # Step 3: Copy application files to targeted location within Profile_home
    cp "{{ Profile_home }}/temp_directory/$file" "{{ Profile_home }}/$target"
done < "{{ Profile_home }}/temp_directory/release.txt"

echo "Deployment completed successfully."
=================================

Run cd /ansible/GITHUB_RUNNER/actions-runner10/_work/IBPS-Deployment/IBPS-Deployment
  cd /ansible/GITHUB_RUNNER/actions-runner10/_work/IBPS-Deployment/IBPS-Deployment
  ansible-playbook -b -vvv --extra-vars "target=target_jb destination=/ansible/GITHUB_RUNNER/actions-runner10/_work/IBPS-Deployment/IBPS-Deployment" ./playbook/IBPS-deployment.yml
  shell: /usr/bin/bash -e {0}
  env:
    TOKEN_GITHUB: ***
  
ansible-playbook 2.8.18
  config file = /ansible/GITHUB_RUNNER/actions-runner10/_work/IBPS-Deployment/IBPS-Deployment/ansible.cfg
  configured module search path = ['/home/itdevtra/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules']
  ansible python module location = /usr/lib/python3.6/site-packages/ansible
  executable location = /usr/bin/ansible-playbook
  python version = 3.6.8 (default, Jan 14 2022, 11:04:20) [GCC 8.5.0 20210514 (Red Hat 8.5.0-7)]
Using /ansible/GITHUB_RUNNER/actions-runner10/_work/IBPS-Deployment/IBPS-Deployment/ansible.cfg as config file
host_list declined parsing /ansible/GITHUB_RUNNER/actions-runner10/_work/IBPS-Deployment/IBPS-Deployment/hosts.cfg as it did not pass it's verify_file() method
script declined parsing /ansible/GITHUB_RUNNER/actions-runner10/_work/IBPS-Deployment/IBPS-Deployment/hosts.cfg as it did not pass it's verify_file() method
auto declined parsing /ansible/GITHUB_RUNNER/actions-runner10/_work/IBPS-Deployment/IBPS-Deployment/hosts.cfg as it did not pass it's verify_file() method
yaml declined parsing /ansible/GITHUB_RUNNER/actions-runner10/_work/IBPS-Deployment/IBPS-Deployment/hosts.cfg as it did not pass it's verify_file() method
Parsed /ansible/GITHUB_RUNNER/actions-runner10/_work/IBPS-Deployment/IBPS-Deployment/hosts.cfg inventory source with ini plugin
ERROR! Syntax Error while loading YAML.
  did not find expected key

The error appears to be in '/ansible/GITHUB_RUNNER/actions-runner10/_work/IBPS-Deployment/IBPS-Deployment/roles/IBPS-deployment/tasks/main.yml': line 19, column 16, but may
be elsewhere in the file depending on the exact syntax problem.

The offending line appears to be:

      file:
        path: "/tmp/{{ zip_file_name }}"
               ^ here
We could be wrong, but this one looks like it might be an issue with
missing quotes. Always quote template expression brackets when they
start a value. For instance:

    with_items:
      - {{ foo }}

Should be written as:

    with_items:
      - "{{ foo }}"
Error: Process completed with exit code 4.
