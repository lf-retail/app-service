- name: Download zip from GitHub packages on Runner
  delegate_to: localhost
  run_once: true
  get_url:
    url: "{{ zip_file_url }}"
    dest: "/tmp/{{ zip_file_name }}"
    headers:
      Authorization: "token {{ github_token }}"

- name: Copy release.zip to Target Server
  copy:
    src: "/tmp/{{ zip_file_name }}"
    dest: "{{ Profile_home }}/{{ zip_file_name }}"

- name: Extract release.zip on Target Server
  become: true
  become_user: "{{ ansible_user }}"
  unarchive:
    src: "{{ Profile_home }}/{{ zip_file_name }}"
    dest: "{{ Profile_home }}/"
    remote_src: yes
  register: unarchive_result  

- name: Run ls -la on the Target Server
  become: true
  become_user: "{{ ansible_user }}"
  command: "ls -la {{ Profile_home }}/release/"
  register: ls_result    

- name: Display ls -la result
  debug:
    var: ls_result.stdout_lines   

- name: Read release.txt content
  become: true
  become_user: "{{ ansible_user }}"
  shell: cat "{{ Profile_home }}/release/release.txt"
  register: release_content

- name: Create backup directory for each application
  become: true
  become_user: "{{ ansible_user }}"
  command: "mkdir -p {{ backup_location }}/{{ item.1 }}/backup"
  loop: "{{ release_content.stdout_lines | map('regex_replace', '^.+?,(.+)$', '\\1') | list }}"
  when: 
    - release_content.stdout_lines | length > 0
    - not (backup_location ~ '/backup$' and (item.1 | regex_search(backup_location | regex_replace('/backup$', '')) | bool))

- name: Backup old deployment files for each application
  become: true
  become_user: "{{ ansible_user }}"
  command: "cp -r {{ targeted_location }}/{{ item.0 }} {{ backup_location }}/{{ item.1 }}/backup/"
  loop: "{{ release_content.stdout_lines | map('regex_replace', '^(.+?),(.+)$', '\\1 \\2') | list }}"
  when: release_content.stdout_lines | length > 0

- name: Add backup details to change.log file
  become: true
  become_user: "{{ ansible_user }}"
  shell: |
    echo "Backup details for {{ item.1 }} at $(date):" >> {{ backup_location }}/{{ item.1 }}/change.log
    echo "-----------------------------" >> {{ backup_location }}/{{ item.1 }}/change.log
    ls -la {{ backup_location }}/{{ item.1 }}/backup/ >> {{ backup_location }}/{{ item.1 }}/change.log
  loop: "{{ release_content.stdout_lines | map('regex_replace', '^.+?,(.+)$', '\\1') | list }}"
  when: release_content.stdout_lines | length > 0

- name: Copy application files to targeted location on Target Server
  become: true
  become_user: "{{ ansible_user }}"
  command: "cd {{ Profile_home }}/release && cp {{ item.0 }} {{ item.1 }}"
  loop: "{{ release_content.stdout_lines | map('regex_replace', '^(.+?),(.+)$', '\\1 \\2') | list }}"
  when: release_content.stdout_lines | length > 0

- name: Rollback to previous deployment if needed
  become: true
  become_user: "{{ ansible_user }}"
  command: |
    latest_backup=$(ls -td {{ backup_location }}/{{ item.1 }}/backup/* | head -n 1)
    if [ -n "$latest_backup" ]; then
      echo "Rolling back {{ item.1 }} to the previous deployment."
      cp -r $latest_backup/* {{ item.2 }}
    else
      echo "No previous backups found for {{ item.1 }}. Skipping rollback."
    fi
  loop: "{{ release_content.stdout_lines | map('regex_replace', '^(.+?),(.+?),(.+)$', '\\1 \\2 \\3') | list }}"
  when: release_content.stdout_lines | length > 0 and deploy_result.failed
============================
TASK [IBPS-deployment : Backup old deployment files for each application] ******
task path: /ansible/GITHUB_RUNNER/actions-runner10/_work/IBPS-Deployment/IBPS-Deployment/roles/IBPS-deployment/tasks/main.yml:49
<10.15.13.148> ESTABLISH SSH CONNECTION FOR USER: itdevtra
<10.15.13.148> SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o StrictHostKeyChecking=no -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o 'User="itdevtra"' -o ConnectTimeout=30 -o ControlPath=/home/itdevtra/.ansible/cp/2b6c10444a 10.15.13.148 '/bin/sh -c '"'"'( umask 77 && mkdir -p "` echo /tmp `"&& mkdir /tmp/ansible-tmp-1705135644.7704923-2817893-127485866162438 && echo ansible-tmp-1705135644.7704923-2817893-127485866162438="` echo /tmp/ansible-tmp-1705135644.7704923-2817893-127485866162438 `" ) && sleep 0'"'"''
<10.15.13.148> (0, b'ansible-tmp-1705135644.7704923-2817893-127485866162438=/tmp/ansible-tmp-1705135644.7704923-2817893-127485866162438\n', b'')
Using module file /usr/lib/python3.6/site-packages/ansible/modules/commands/command.py
<10.15.13.148> PUT /home/itdevtra/.ansible/tmp/ansible-local-2817796t12utroy/tmp04gsvnmw TO /tmp/ansible-tmp-1705135644.7704923-2817893-127485866162438/AnsiballZ_command.py
<10.15.13.148> SSH: EXEC sftp -b - -C -o ControlMaster=auto -o ControlPersist=60s -o StrictHostKeyChecking=no -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o 'User="itdevtra"' -o ConnectTimeout=30 -o ControlPath=/home/itdevtra/.ansible/cp/2b6c10444a '[10.15.13.148]'
<10.15.13.148> (0, b'sftp> put /home/itdevtra/.ansible/tmp/ansible-local-2817796t12utroy/tmp04gsvnmw /tmp/ansible-tmp-1705135644.7704923-2817893-127485866162438/AnsiballZ_command.py\n', b'')
<10.15.13.148> ESTABLISH SSH CONNECTION FOR USER: itdevtra
<10.15.13.148> SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o StrictHostKeyChecking=no -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o 'User="itdevtra"' -o ConnectTimeout=30 -o ControlPath=/home/itdevtra/.ansible/cp/2b6c10444a 10.15.13.148 '/bin/sh -c '"'"'chmod u+x /tmp/ansible-tmp-1705135644.7704923-2817893-127485866162438/ /tmp/ansible-tmp-1705135644.7704923-2817893-127485866162438/AnsiballZ_command.py && sleep 0'"'"''
<10.15.13.148> (0, b'', b'')
<10.15.13.148> ESTABLISH SSH CONNECTION FOR USER: itdevtra
<10.15.13.148> SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o StrictHostKeyChecking=no -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o 'User="itdevtra"' -o ConnectTimeout=30 -o ControlPath=/home/itdevtra/.ansible/cp/2b6c10444a -tt 10.15.13.148 '/bin/sh -c '"'"'/usr/bin/python /tmp/ansible-tmp-1705135644.7704923-2817893-127485866162438/AnsiballZ_command.py && sleep 0'"'"''
<10.15.13.148> (1, b'\r\n{"changed": true, "end": "2024-01-13 12:48:03.322494", "stdout": "", "cmd": ["cp", "-r", "/ibm/IBM-CAS/WebSphere/AppServer/profiles/AppSrv01/installedApps/ANT2CASAPPS01Node01Cell/n", "/ibm/IBM-CAS/WebSphere/AppServer/profiles/AppSrv01/backup/e/backup/"], "failed": true, "delta": "0:00:00.358827", "stderr": "cp: cannot stat \\u2018/ibm/IBM-CAS/WebSphere/AppServer/profiles/AppSrv01/installedApps/ANT2CASAPPS01Node01Cell/n\\u2019: No such file or directory", "rc": 1, "invocation": {"module_args": {"creates": null, "executable": null, "_uses_shell": false, "strip_empty_ends": true, "_raw_params": "cp -r /ibm/IBM-CAS/WebSphere/AppServer/profiles/AppSrv01/installedApps/ANT2CASAPPS01Node01Cell/n /ibm/IBM-CAS/WebSphere/AppServer/profiles/AppSrv01/backup/e/backup/", "removes": null, "argv": null, "warn": false, "chdir": null, "stdin_add_newline": true, "stdin": null}}, "start": "2024-01-13 12:48:02.963667", "msg": "non-zero return code"}\r\n', b'Shared connection to 10.15.13.148 closed.\r\n')
<10.15.13.148> Failed to connect to the host via ssh: Shared connection to 10.15.13.148 closed.
<10.15.13.148> ESTABLISH SSH CONNECTION FOR USER: itdevtra
<10.15.13.148> SSH: EXEC ssh -C -o ControlMaster=auto -o ControlPersist=60s -o StrictHostKeyChecking=no -o Port=22 -o KbdInteractiveAuthentication=no -o PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,publickey -o PasswordAuthentication=no -o 'User="itdevtra"' -o ConnectTimeout=30 -o ControlPath=/home/itdevtra/.ansible/cp/2b6c10444a 10.15.13.148 '/bin/sh -c '"'"'rm -f -r /tmp/ansible-tmp-1705135644.7704923-2817893-127485866162438/ > /dev/null 2>&1 && sleep 0'"'"''
<10.15.13.148> (0, b'', b'')
failed: [ANT3CASAPPS01] (item=newgenapp_jar.ear /ibm/IBM-CAS/WebSphere/AppServer/profiles/AppSrv01/installedApps/ANT2CASAPPS01Node01Cell) => {
    "ansible_loop_var": "item",
    "changed": true,
    "cmd": [
        "cp",
        "-r",
        "/ibm/IBM-CAS/WebSphere/AppServer/profiles/AppSrv01/installedApps/ANT2CASAPPS01Node01Cell/n",
        "/ibm/IBM-CAS/WebSphere/AppServer/profiles/AppSrv01/backup/e/backup/"
    ],
    "delta": "0:00:00.358827",
    "end": "2024-01-13 12:48:03.322494",
    "invocation": {
        "module_args": {
            "_raw_params": "cp -r /ibm/IBM-CAS/WebSphere/AppServer/profiles/AppSrv01/installedApps/ANT2CASAPPS01Node01Cell/n /ibm/IBM-CAS/WebSphere/AppServer/profiles/AppSrv01/backup/e/backup/",
            "_uses_shell": false,
            "argv": null,
            "chdir": null,
            "creates": null,
            "executable": null,
            "removes": null,
            "stdin": null,
            "stdin_add_newline": true,
            "strip_empty_ends": true,
            "warn": false
        }
    },
    "item": "newgenapp_jar.ear /ibm/IBM-CAS/WebSphere/AppServer/profiles/AppSrv01/installedApps/ANT2CASAPPS01Node01Cell",
    "msg": "non-zero return code",
    "rc": 1,
    "start": "2024-01-13 12:48:02.963667",
    "stderr": "cp: cannot stat ‘/ibm/IBM-CAS/WebSphere/AppServer/profiles/AppSrv01/installedApps/ANT2CASAPPS01Node01Cell/n’: No such file or directory",
    "stderr_lines": [
        "cp: cannot stat ‘/ibm/IBM-CAS/WebSphere/AppServer/profiles/AppSrv01/installedApps/ANT2CASAPPS01Node01Cell/n’: No such file or directory"
    ],
    "stdout": "",
    "stdout_lines": []
}

PLAY RECAP *********************************************************************
ANT3CASAPPS01              : ok=8    changed=3    unreachable=0    failed=1    skipped=0    rescued=0    ignored=0   

Error: Process completed with exit code 2.
